{% comment %}
  Virtual Try-On Widget - Theme App Extension Block
  This block loads the VTON widget script on product pages
{% endcomment %}

{% if template.name == 'product' %}
  <div 
    id="vton-widget-container" 
    data-vton-widget="true"
    style="margin: 16px 0;"
  >
    {% comment %} Widget will be injected here automatically {% endcomment %}
  </div>

<script>
    (function() {
      'use strict';
      
      // Only load widget script if not already loaded
      if (window.VTONWidgetLoaded) {
        console.log('[VTON] Widget already loaded, skipping');
        return;
      }
      
      window.VTONWidgetLoaded = true;
      
      // Get app URL - use shop URL with app proxy path
      // The app proxy is configured to route /apps/tryon/* to the app
      const shopUrl = '{{ shop.url }}';
      const appUrl = shopUrl; // Use shop URL, app proxy will route to the app
      
      // Use timestamp for cache busting - this ensures the widget updates on each page load
      // The server will also set proper cache headers
      const cacheBuster = Date.now();
      const widgetUrl = `${appUrl}/apps/tryon/widget-v2.js?v=${cacheBuster}`;
      
      console.log('[VTON] Loading widget from:', widgetUrl);
      
      // Load widget script
      const script = document.createElement('script');
      script.src = widgetUrl;
      script.defer = true;
      script.async = true;
      script.crossOrigin = 'anonymous';
      
      script.onload = function() {
        console.log('[VTON] Widget script loaded successfully');
      };
      
      script.onerror = function() {
        console.error('[VTON] Failed to load widget script from:', widgetUrl);
        // Try fallback URL
        const fallbackUrl = `{{ shop.url }}/apps/tryon/widget-v2.js?v=${widgetVersion}&t=${Date.now()}`;
        console.log('[VTON] Trying fallback URL:', fallbackUrl);
        const fallbackScript = document.createElement('script');
        fallbackScript.src = fallbackUrl;
        fallbackScript.defer = true;
        fallbackScript.async = true;
        document.head.appendChild(fallbackScript);
      };
      
      document.head.appendChild(script);
    })();
  </script>
{% endif %}

{% schema %}
{
  "name": "Virtual Try-On Widget",
  "target": "section",
  "settings": [
    {
      "type": "header",
      "content": "Virtual Try-On Configuration"
    },
    {
      "type": "paragraph",
      "content": "This block automatically loads the Virtual Try-On widget on product pages. The widget will appear next to the 'Add to Cart' button."
    },
    {
      "type": "paragraph",
      "content": "Note: The widget is also automatically installed via Script Tags. This block is optional and can be used for manual integration."
    }
  ]
}
{% endschema %}
