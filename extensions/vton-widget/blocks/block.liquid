{% comment %}
  Virtual Try-On Widget - App Embed Block
  This block injects the VTON widget script on product pages
{% endcomment %}

{% if template.name == 'product' %}
  <script>
    (function() {
      'use strict';
      
      // Wait for DOM to be ready
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initWidget);
      } else {
        initWidget();
      }
      
      function initWidget() {
        // Extract shop domain
        const shop = extractShop();
        if (!shop) {
          console.warn('[VTON] Shop domain not found');
          return;
        }
        
        // Extract product ID from URL
        const productId = extractProductId();
        if (!productId) {
          console.warn('[VTON] Product ID not found');
          return;
        }
        
        // Check status and initialize widget
        checkStatus(shop, productId).then(function(status) {
          if (status && status.enabled) {
            initializeWidget(shop, productId, status.widget_settings || {});
          }
        }).catch(function(error) {
          console.error('[VTON] Failed to check status:', error);
        });
      }
      
      function extractShop() {
        if (window.Shopify && window.Shopify.shop) {
          return window.Shopify.shop;
        }
        const hostname = window.location.hostname;
        const match = hostname.match(/([^.]+\.myshopify\.com)/);
        return match ? match[1] : hostname;
      }
      
      function extractProductId() {
        // Try to get Shopify product ID (GID) from various sources
        // 1. Try from data attribute on product form
        const productForm = document.querySelector('form[action*="/cart/add"]');
        if (productForm) {
          const productId = productForm.getAttribute('data-product-id') || 
                           productForm.querySelector('[name="id"]')?.getAttribute('value');
          if (productId) {
            // Convert numeric ID to GID format if needed
            if (/^\d+$/.test(productId)) {
              return 'gid://shopify/Product/' + productId;
            }
            // Already in GID format
            if (productId.startsWith('gid://shopify/Product/')) {
              return productId;
            }
          }
        }
        
        // 2. Try from meta tag with product ID
        const productIdMeta = document.querySelector('meta[property="product:retailer_item_id"]') ||
                              document.querySelector('meta[name="product-id"]') ||
                              document.querySelector('[data-product-id]');
        if (productIdMeta) {
          const productId = productIdMeta.getAttribute('content') || 
                           productIdMeta.getAttribute('data-product-id');
          if (productId) {
            if (/^\d+$/.test(productId)) {
              return 'gid://shopify/Product/' + productId;
            }
            if (productId.startsWith('gid://shopify/Product/')) {
              return productId;
            }
          }
        }
        
        // 3. Try from Shopify global object
        if (window.Shopify && window.Shopify.product && window.Shopify.product.id) {
          const productId = window.Shopify.product.id;
          if (/^\d+$/.test(String(productId))) {
            return 'gid://shopify/Product/' + productId;
          }
          if (String(productId).startsWith('gid://shopify/Product/')) {
            return String(productId);
          }
        }
        
        // 4. Fallback: Try from URL (handle) - will need conversion in backend
        const urlMatch = window.location.pathname.match(/\/products\/([^\/\?]+)/);
        if (urlMatch) {
          return urlMatch[1]; // Return handle as fallback
        }
        
        // 5. Try from meta tag
        const meta = document.querySelector('meta[property="og:url"]');
        if (meta) {
          const match = meta.content.match(/\/products\/([^\/\?]+)/);
          if (match) return match[1];
        }
        
        return null;
      }
      
      function checkStatus(shop, productId) {
        // Construct absolute URL for app proxy
        const url = window.location.origin + '/apps/tryon/status?shop=' + encodeURIComponent(shop) + '&product_id=' + encodeURIComponent(productId);
        
        return fetch(url, {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json'
          }
        }).then(function(response) {
          if (!response.ok) {
            throw new Error('Status check failed: ' + response.status);
          }
          return response.json();
        }).catch(function(error) {
          throw error;
        });
      }
      
      function getProductImage() {
        // Try multiple selectors to find product image
        const selectors = [
          '.product__media img',
          '.product-single__media img',
          '[data-product-image] img',
          '.product-media img',
          '.product-photos img',
          '.product-gallery img',
          'img[data-product-image]',
          '.product__photo img',
          'img.product-featured-image'
        ];
        
        for (const selector of selectors) {
          const img = document.querySelector(selector);
          if (img && img.src) {
            // Get the full-size image URL (remove size parameters)
            const imageUrl = img.src.split('?')[0].replace(/_small|_medium|_large|_grande/g, '');
            return imageUrl;
          }
        }
        
        return null;
      }
      
      function initializeWidget(shop, productId, widgetSettings) {
        // Find product form container
        const productForm = document.querySelector('form[action*="/cart/add"]');
        if (!productForm || !productForm.parentNode) {
          console.warn('[VTON] Product form not found');
          return;
        }
        
        // Check if widget already exists
        if (document.getElementById('vton-widget-container')) {
          return;
        }
        
        // Get product image URL from the page
        const productImageUrl = getProductImage();
        
        // Create widget container
        const container = document.createElement('div');
        container.id = 'vton-widget-container';
        container.setAttribute('data-vton-widget', 'true');
        
        // Insert after product form
        productForm.parentNode.insertBefore(container, productForm.nextSibling);
        
        // Create shadow DOM
        const shadowRoot = container.attachShadow({ mode: 'closed' });
        
        // Widget state
        const state = {
          shop: shop,
          productId: productId,
          widgetSettings: widgetSettings,
          productImageUrl: productImageUrl,
          userPhoto: null,
          resultImageUrl: null,
          modalOpen: false
        };
        
        // Render widget
        renderWidget(shadowRoot, state);
        
        // Make widget accessible globally for event handlers
        window.vtonWidgetInstance = {
          openModal: function() {
            openModal(shadowRoot, state);
          },
          closeModal: function() {
            closeModal(shadowRoot, state);
          },
          triggerFileInput: function() {
            const fileInput = shadowRoot.getElementById('vton-file-input');
            if (fileInput) fileInput.click();
          },
          generate: function() {
            generateTryOn(shadowRoot, state);
          },
          handleFileChange: function(event) {
            handleFileChange(event, shadowRoot, state);
          },
          handleAddToCart: function() {
            handleAddToCart(shadowRoot, state);
          },
          startLoadingMessages: function() {
            startLoadingMessages(shadowRoot);
          },
          stopLoadingMessages: function() {
            stopLoadingMessages(shadowRoot);
          }
        };
      }
      
      function renderWidget(shadowRoot, state) {
        const settings = state.widgetSettings;
        const buttonText = settings.widget_text || 'Try It On Now âœ¨';
        const buttonBg = settings.widget_bg || '#000000';
        const buttonColor = settings.widget_color || '#ffffff';
        
        shadowRoot.innerHTML = `
          <style>
            .vton-widget-container {
              margin: 20px 0;
              width: 100%;
            }
            .vton-button {
              width: 100%;
              padding: 14px 24px;
              border: none;
              border-radius: 4px;
              font-size: 16px;
              font-weight: 600;
              cursor: pointer;
            }
            .vton-modal-overlay {
              position: fixed;
              top: 0;
              left: 0;
              right: 0;
              bottom: 0;
              background: rgba(0, 0, 0, 0.7);
              display: none;
              align-items: center;
              justify-content: center;
              z-index: 99999;
              padding: 20px;
            }
            .vton-modal-overlay.active {
              display: flex;
            }
            .vton-modal {
              background: white;
              border-radius: 8px;
              max-width: 600px;
              width: 100%;
              max-height: 90vh;
              overflow-y: auto;
              position: relative;
            }
            .vton-modal-close {
              position: absolute;
              top: 12px;
              right: 12px;
              background: none;
              border: none;
              font-size: 28px;
              cursor: pointer;
              padding: 4px 12px;
              line-height: 1;
              color: #666;
            }
            .vton-modal-content {
              padding: 24px;
            }
            .vton-upload-area {
              border: 2px dashed #ccc;
              border-radius: 8px;
              padding: 40px;
              text-align: center;
              cursor: pointer;
              margin-bottom: 16px;
            }
            .vton-upload-area p {
              margin: 0;
              font-size: 14px;
              color: #666;
            }
            .vton-upload-area.has-image {
              border: none;
              padding: 0;
            }
            .vton-upload-area img {
              max-width: 100%;
              border-radius: 8px;
            }
            .vton-privacy-notice {
              font-size: 12px;
              color: #999;
              text-align: center;
              margin: 12px 0;
              font-style: italic;
            }
            .vton-generate-btn {
              width: 100%;
              padding: 14px;
              border: none;
              border-radius: 4px;
              font-size: 16px;
              font-weight: 600;
              cursor: pointer;
              margin-top: 16px;
            }
            .vton-generate-btn:disabled {
              opacity: 0.6;
              cursor: not-allowed;
            }
            .vton-loading {
              text-align: center;
              padding: 40px;
              display: none;
            }
            .vton-loading.active {
              display: block;
            }
            .vton-spinner {
              border: 3px solid #f3f3f3;
              border-top: 3px solid ${buttonBg};
              border-radius: 50%;
              width: 40px;
              height: 40px;
              animation: spin 1s linear infinite;
              margin: 0 auto 16px;
            }
            .vton-loading-text {
              margin-top: 16px;
              font-size: 14px;
              color: #666;
              font-weight: 500;
              min-height: 20px;
              transition: opacity 0.3s ease-in-out;
            }
            .vton-loading-text.fade-out {
              opacity: 0;
            }
            .vton-loading-subtext {
              margin-top: 8px;
              font-size: 12px;
              color: #999;
              font-style: italic;
            }
            .vton-progress-container {
              width: 100%;
              max-width: 400px;
              margin: 24px auto 16px;
              background: #f0f0f0;
              border-radius: 10px;
              height: 8px;
              overflow: hidden;
              position: relative;
            }
            .vton-progress-bar {
              height: 100%;
              background: linear-gradient(90deg, ${buttonBg}, ${buttonBg}dd);
              border-radius: 10px;
              width: 0%;
              transition: width 0.5s ease-out;
              position: relative;
              overflow: hidden;
            }
            .vton-progress-bar::after {
              content: '';
              position: absolute;
              top: 0;
              left: 0;
              bottom: 0;
              right: 0;
              background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
              animation: shimmer 2s infinite;
            }
            @keyframes shimmer {
              0% { transform: translateX(-100%); }
              100% { transform: translateX(100%); }
            }
            .vton-progress-text {
              text-align: center;
              font-size: 13px;
              color: #666;
              margin-top: 8px;
              font-weight: 500;
            }
            .vton-timer {
              text-align: center;
              font-size: 12px;
              color: #999;
              margin-top: 12px;
              font-family: monospace;
            }
            .vton-steps {
              display: flex;
              justify-content: center;
              gap: 8px;
              margin-top: 20px;
              flex-wrap: wrap;
            }
            .vton-step {
              padding: 6px 12px;
              border-radius: 20px;
              font-size: 11px;
              font-weight: 600;
              background: #f0f0f0;
              color: #999;
              transition: all 0.3s ease;
            }
            .vton-step.active {
              background: ${buttonBg};
              color: ${buttonColor};
              transform: scale(1.1);
            }
            .vton-step.completed {
              background: #28a745;
              color: #fff;
            }
            .vton-loading-dots {
              display: inline-block;
              margin-left: 4px;
            }
            .vton-loading-dots span {
              display: inline-block;
              width: 4px;
              height: 4px;
              border-radius: 50%;
              background: ${buttonBg};
              margin: 0 2px;
              animation: dotPulse 1.4s infinite ease-in-out;
            }
            .vton-loading-dots span:nth-child(1) { animation-delay: 0s; }
            .vton-loading-dots span:nth-child(2) { animation-delay: 0.2s; }
            .vton-loading-dots span:nth-child(3) { animation-delay: 0.4s; }
            @keyframes dotPulse {
              0%, 80%, 100% { transform: scale(0.8); opacity: 0.5; }
              40% { transform: scale(1.2); opacity: 1; }
            }
            @keyframes spin {
              0% { transform: rotate(0deg); }
              100% { transform: rotate(360deg); }
            }
            .vton-result {
              margin-top: 16px;
              display: none;
            }
            .vton-result.active {
              display: block;
            }
            .vton-result img {
              width: 100%;
              border-radius: 8px;
            }
            .vton-error {
              color: #d32f2f;
              text-align: center;
              padding: 16px;
              display: none;
            }
            .vton-error.active {
              display: block;
            }
            @media (max-width: 640px) {
              .vton-widget-container {
                margin: 16px 0;
              }
              .vton-button {
                padding: 12px 20px;
                font-size: 15px;
              }
              .vton-modal-overlay {
                padding: 10px;
              }
              .vton-modal {
                max-width: 100%;
                max-height: 95vh;
                border-radius: 8px 8px 0 0;
              }
              .vton-modal-content {
                padding: 20px 16px;
              }
              .vton-upload-area {
                padding: 32px 20px;
              }
              .vton-upload-area p {
                font-size: 13px;
              }
              .vton-generate-btn {
                padding: 12px;
                font-size: 15px;
              }
              .vton-modal-close {
                top: 8px;
                right: 8px;
                font-size: 32px;
                padding: 8px;
              }
              .vton-loading {
                padding: 32px 20px;
              }
              .vton-loading-text {
                font-size: 13px;
              }
              .vton-privacy-notice {
                font-size: 11px;
                padding: 8px;
                margin: 8px 0;
              }
              .vton-error {
                padding: 12px;
                font-size: 14px;
              }
            }
            @media (max-width: 480px) {
              .vton-button {
                padding: 11px 16px;
                font-size: 14px;
              }
              .vton-modal-content {
                padding: 16px 12px;
              }
              .vton-upload-area {
                padding: 28px 16px;
              }
              .vton-generate-btn {
                padding: 11px;
                font-size: 14px;
              }
              .vton-loading {
                padding: 28px 16px;
              }
            }
          </style>
          <div class="vton-widget-container">
            <button class="vton-button" style="background: ${buttonBg}; color: ${buttonColor};" onclick="window.vtonWidgetInstance.openModal()">
              ${buttonText}
            </button>
          </div>
          <div id="vton-modal-overlay" class="vton-modal-overlay" onclick="if(event.target === this) window.vtonWidgetInstance.closeModal()">
            <div class="vton-modal">
              <button class="vton-modal-close" onclick="window.vtonWidgetInstance.closeModal()">&times;</button>
              <div class="vton-modal-content">
                <div id="vton-upload-area" class="vton-upload-area" onclick="window.vtonWidgetInstance.triggerFileInput()">
                  <input type="file" id="vton-file-input" accept="image/*" style="display: none;" onchange="window.vtonWidgetInstance.handleFileChange(event)" />
                  <p>Click to upload your photo</p>
                </div>
                <p class="vton-privacy-notice">ðŸ”’ No personal data is stored. Your photos are processed securely and deleted after generation.</p>
                <button id="vton-generate-btn" class="vton-generate-btn" style="background: ${buttonBg}; color: ${buttonColor};" onclick="window.vtonWidgetInstance.generate()" disabled>
                  Generate
                </button>
                <div id="vton-loading" class="vton-loading">
                  <div class="vton-spinner"></div>
                  <p id="vton-loading-message" class="vton-loading-text">Preparing your virtual try-on experience<span class="vton-loading-dots"><span></span><span></span><span></span></span></p>
                  <div class="vton-progress-container">
                    <div id="vton-progress-bar" class="vton-progress-bar"></div>
                  </div>
                  <p id="vton-progress-text" class="vton-progress-text">0%</p>
                  <div class="vton-steps">
                    <div id="vton-step-1" class="vton-step active">1. Analyzing</div>
                    <div id="vton-step-2" class="vton-step">2. Processing</div>
                    <div id="vton-step-3" class="vton-step">3. Generating</div>
                    <div id="vton-step-4" class="vton-step">4. Finalizing</div>
                  </div>
                  <p id="vton-timer" class="vton-timer">Time elapsed: <span id="vton-timer-value">0s</span></p>
                  <p class="vton-loading-subtext">This usually takes 30-40 seconds</p>
                  <p class="vton-privacy-notice">No personal data is stored.</p>
                </div>
                <div id="vton-result" class="vton-result"></div>
                <div id="vton-error" class="vton-error"></div>
              </div>
            </div>
          </div>
        `;
      }
      
      function openModal(shadowRoot, state) {
        const overlay = shadowRoot.getElementById('vton-modal-overlay');
        if (overlay) {
          overlay.classList.add('active');
          state.modalOpen = true;
        }
      }
      
      function closeModal(shadowRoot, state) {
        const overlay = shadowRoot.getElementById('vton-modal-overlay');
        if (overlay) {
          overlay.classList.remove('active');
          state.modalOpen = false;
        }
      }
      
      function handleFileChange(event, shadowRoot, state) {
        const file = event.target.files && event.target.files[0];
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = function(e) {
          state.userPhoto = e.target.result;
          const uploadArea = shadowRoot.getElementById('vton-upload-area');
          const generateBtn = shadowRoot.getElementById('vton-generate-btn');
          if (uploadArea) {
            uploadArea.className = 'vton-upload-area has-image';
            uploadArea.innerHTML = '<img src="' + state.userPhoto + '" alt="Preview" />';
          }
          if (generateBtn) {
            generateBtn.disabled = false;
          }
        };
        reader.readAsDataURL(file);
      }
      
      function handleAddToCart(shadowRoot, state) {
        console.log('[VTON] handleAddToCart called');
        
        // Get the button in the result to show loading state
        const atcButton = shadowRoot.querySelector('.vton-add-to-cart-btn');
        const originalButtonText = atcButton ? atcButton.textContent : 'Add to Cart';
        
        // Disable button and show loading
        if (atcButton) {
          atcButton.disabled = true;
          atcButton.textContent = 'Adding to cart...';
          atcButton.style.opacity = '0.7';
          atcButton.style.cursor = 'not-allowed';
        }
        
        // Method 1: Try to find and click the original Add to Cart button (most reliable)
        const addToCartButton = document.querySelector('form[action*="/cart/add"] button[type="submit"], form[action*="/cart/add"] input[type="submit"], button[name="add"], .product-form__cart-submit, [data-add-to-cart], button[type="submit"][form*="product"]');
        
        if (addToCartButton) {
          console.log('[VTON] Found Add to Cart button, clicking it...');
          
          // Trigger click on the original button
          if (addToCartButton instanceof HTMLElement) {
            addToCartButton.click();
            
            // Update button to show success after a short delay
            setTimeout(function() {
              if (atcButton) {
                atcButton.textContent = 'âœ“ Added to Cart!';
                atcButton.style.background = '#28a745';
                
                setTimeout(function() {
                  if (atcButton) {
                    atcButton.textContent = originalButtonText;
                    atcButton.style.background = state.widgetSettings.widget_bg || '#000000';
                    atcButton.disabled = false;
                    atcButton.style.opacity = '1';
                    atcButton.style.cursor = 'pointer';
                  }
                }, 2000);
              }
              
              // Track the add to cart event
              trackAddToCart(state);
            }, 500);
            
            return;
          }
        }
        
        // Method 2: Find the form and submit it directly
        const addToCartForm = document.querySelector('form[action*="/cart/add"]');
        
        if (addToCartForm) {
          console.log('[VTON] Found Add to Cart form, submitting...');
          
          // Check if form has variant selected
          const variantInput = addToCartForm.querySelector('input[name="id"], select[name="id"]');
          if (!variantInput || !variantInput.value) {
            console.warn('[VTON] No variant selected in form');
            if (atcButton) {
              atcButton.disabled = false;
              atcButton.textContent = originalButtonText;
              atcButton.style.opacity = '1';
              atcButton.style.cursor = 'pointer';
            }
            alert('Please select a product variant (size, color, etc.) before adding to cart.');
            return;
          }
          
          // Submit the form directly
          if (addToCartForm instanceof HTMLFormElement) {
            addToCartForm.submit();
            
            // Update button to show success
            setTimeout(function() {
              if (atcButton) {
                atcButton.textContent = 'âœ“ Added to Cart!';
                atcButton.style.background = '#28a745';
                
                setTimeout(function() {
                  if (atcButton) {
                    atcButton.textContent = originalButtonText;
                    atcButton.style.background = state.widgetSettings.widget_bg || '#000000';
                    atcButton.disabled = false;
                    atcButton.style.opacity = '1';
                    atcButton.style.cursor = 'pointer';
                  }
                }, 2000);
              }
              
              // Track the add to cart event
              trackAddToCart(state);
            }, 500);
            
            return;
          }
        }
        
        // Method 3: Use AJAX API as fallback
        console.log('[VTON] Trying AJAX method...');
        
        if (!addToCartForm) {
          console.error('[VTON] Add to Cart form not found');
          if (atcButton) {
            atcButton.disabled = false;
            atcButton.textContent = originalButtonText;
            atcButton.style.opacity = '1';
            atcButton.style.cursor = 'pointer';
          }
          alert('Unable to find the product form. Please use the regular Add to Cart button on the page.');
          return;
        }
        
        // Collect form data
        const formData = new FormData(addToCartForm);
        
        // Get quantity (default to 1 if not specified)
        let quantity = formData.get('quantity') || '1';
        if (!quantity || quantity === '') {
          quantity = '1';
        }
        
        // Get variant ID (required) - try multiple methods
        let variantId = formData.get('id') || formData.get('variant_id');
        
        // If not found in form data, try to find it in the form inputs
        if (!variantId) {
          const variantInput = addToCartForm.querySelector('input[name="id"], select[name="id"]');
          if (variantInput) {
            variantId = variantInput.value;
          }
        }
        
        if (!variantId) {
          console.error('[VTON] Variant ID not found in form');
          if (atcButton) {
            atcButton.disabled = false;
            atcButton.textContent = originalButtonText;
            atcButton.style.opacity = '1';
            atcButton.style.cursor = 'pointer';
          }
          alert('Please select a product variant (size, color, etc.) before adding to cart.');
          return;
        }
        
        console.log('[VTON] Using variant ID:', variantId, 'quantity:', quantity);
        
        // Prepare cart add data
        const cartData = {
          id: variantId,
          quantity: parseInt(quantity, 10) || 1
        };
        
        // Add any additional properties (for custom products)
        formData.forEach((value, key) => {
          if (key.startsWith('properties[')) {
            if (!cartData.properties) {
              cartData.properties = {};
            }
            const propKey = key.replace('properties[', '').replace(']', '');
            cartData.properties[propKey] = value;
          }
        });
        
        console.log('[VTON] Sending cart data:', cartData);
        
        // Submit to Shopify cart using AJAX
        fetch('/cart/add.js', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Accept': 'application/json'
          },
          body: JSON.stringify(cartData)
        })
        .then(function(response) {
          console.log('[VTON] Cart add response status:', response.status);
          return response.json().then(function(data) {
            console.log('[VTON] Cart add response data:', data);
            if (!response.ok) {
              throw new Error(data.description || data.message || 'Failed to add to cart');
            }
            return data;
          });
        })
        .then(function(data) {
          console.log('[VTON] Product added to cart successfully:', data);
          
          // Update button to show success
          if (atcButton) {
            atcButton.textContent = 'âœ“ Added to Cart!';
            atcButton.style.background = '#28a745';
            
            // Reset button after 2 seconds
            setTimeout(function() {
              if (atcButton) {
                atcButton.textContent = originalButtonText;
                atcButton.style.background = state.widgetSettings.widget_bg || '#000000';
                atcButton.disabled = false;
                atcButton.style.opacity = '1';
                atcButton.style.cursor = 'pointer';
              }
            }, 2000);
          }
          
          // Track the add to cart event
          trackAddToCart(state);
          
          // Trigger cart drawer/notification if theme supports it
          const cartUpdatedEvent = new CustomEvent('cart:updated', { detail: data });
          document.dispatchEvent(cartUpdatedEvent);
          
          // Also trigger other common cart events
          document.dispatchEvent(new CustomEvent('cart:add', { detail: data }));
          document.dispatchEvent(new Event('cart:refresh'));
          
          // Try to open cart drawer if theme uses this pattern
          const cartDrawerButton = document.querySelector('[data-cart-drawer-toggle], .cart-drawer-toggle, [aria-controls*="cart"], [data-cart-toggle]');
          if (cartDrawerButton) {
            setTimeout(function() {
              cartDrawerButton.click();
            }, 500);
          }
          
          // Try to refresh cart count if theme has a cart count element
          const cartCountElements = document.querySelectorAll('[data-cart-count], .cart-count, #cart-count');
          cartCountElements.forEach(function(el) {
            if (el instanceof HTMLElement) {
              const currentCount = parseInt(el.textContent || '0', 10);
              el.textContent = String(currentCount + parseInt(quantity, 10));
            }
          });
        })
        .catch(function(error) {
          console.error('[VTON] Error adding to cart:', error);
          
          // Show error on button
          if (atcButton) {
            atcButton.textContent = 'Error - Try Again';
            atcButton.style.background = '#dc3545';
            atcButton.disabled = false;
            atcButton.style.opacity = '1';
            atcButton.style.cursor = 'pointer';
            
            // Reset after 3 seconds
            setTimeout(function() {
              if (atcButton) {
                atcButton.textContent = originalButtonText;
                atcButton.style.background = state.widgetSettings.widget_bg || '#000000';
              }
            }, 3000);
          }
          
          // Show alert for user feedback
          alert('Unable to add product to cart: ' + (error.message || 'Unknown error') + '. Please try using the regular Add to Cart button on the page.');
        });
      }
      
      function trackAddToCart(state) {
        // Track the add to cart event for analytics
        const url = window.location.origin + '/apps/tryon/atc?shop=' + encodeURIComponent(state.shop) + '&product_id=' + encodeURIComponent(state.productId);
        fetch(url, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          }
        }).catch(function(err) {
          console.error('[VTON] Failed to track Add to Cart:', err);
        });
      }
      
      // Loading messages that rotate during generation
      let loadingMessageInterval = null;
      let progressInterval = null;
      let timerInterval = null;
      let startTime = null;
      const loadingMessages = [
        'Preparing your virtual try-on experience',
        'Analyzing your photo and product details',
        'Processing your image with AI technology',
        'Creating your personalized try-on result',
        'Almost there! Finalizing your image',
        'Applying advanced AI algorithms',
        'Optimizing colors and fit for you',
        'Generating your perfect match',
        'Just a few more seconds',
        'Fine-tuning every detail'
      ];
      
      function startLoadingMessages(shadowRoot) {
        startTime = Date.now();
        let messageIndex = 0;
        let progress = 0;
        let currentStep = 1;
        const messageElement = shadowRoot.getElementById('vton-loading-message');
        const progressBar = shadowRoot.getElementById('vton-progress-bar');
        const progressText = shadowRoot.getElementById('vton-progress-text');
        const timerValue = shadowRoot.getElementById('vton-timer-value');
        
        if (!messageElement) return;
        
        // Start timer
        timerInterval = setInterval(function() {
          if (startTime && timerValue) {
            const elapsed = Math.floor((Date.now() - startTime) / 1000);
            timerValue.textContent = elapsed + 's';
          }
        }, 1000);
        
        // Animate progress bar (simulated progress)
        progressInterval = setInterval(function() {
          if (progress < 90) {
            // Simulate progress: faster at start, slower near end
            const increment = progress < 30 ? 2 : (progress < 60 ? 1.5 : 0.8);
            progress = Math.min(progress + increment, 90);
            
            if (progressBar) {
              progressBar.style.width = progress + '%';
            }
            if (progressText) {
              progressText.textContent = Math.floor(progress) + '%';
            }
            
            // Update steps based on progress
            if (progress >= 20 && currentStep === 1) {
              currentStep = 2;
              updateStep(shadowRoot, 1, true);
              updateStep(shadowRoot, 2, false);
            } else if (progress >= 45 && currentStep === 2) {
              currentStep = 3;
              updateStep(shadowRoot, 2, true);
              updateStep(shadowRoot, 3, false);
            } else if (progress >= 70 && currentStep === 3) {
              currentStep = 4;
              updateStep(shadowRoot, 3, true);
              updateStep(shadowRoot, 4, false);
            }
          }
        }, 500);
        
        // Change message every 4 seconds with fade effect
        loadingMessageInterval = setInterval(function() {
          messageIndex = (messageIndex + 1) % loadingMessages.length;
          if (messageElement) {
            // Fade out
            messageElement.classList.add('fade-out');
            
            // Change text and fade in after short delay
            setTimeout(function() {
              const dots = '<span class="vton-loading-dots"><span></span><span></span><span></span></span>';
              messageElement.innerHTML = loadingMessages[messageIndex] + dots;
              messageElement.classList.remove('fade-out');
            }, 300);
          }
        }, 4000);
      }
      
      function updateStep(shadowRoot, stepNum, completed) {
        const stepElement = shadowRoot.getElementById('vton-step-' + stepNum);
        if (stepElement) {
          stepElement.classList.remove('active');
          if (completed) {
            stepElement.classList.add('completed');
          }
        }
      }
      
      function stopLoadingMessages(shadowRoot) {
        if (loadingMessageInterval) {
          clearInterval(loadingMessageInterval);
          loadingMessageInterval = null;
        }
        if (progressInterval) {
          clearInterval(progressInterval);
          progressInterval = null;
        }
        if (timerInterval) {
          clearInterval(timerInterval);
          timerInterval = null;
        }
        
        if (shadowRoot) {
          // Complete progress bar
          const progressBar = shadowRoot.getElementById('vton-progress-bar');
          const progressText = shadowRoot.getElementById('vton-progress-text');
          if (progressBar) {
            progressBar.style.width = '100%';
          }
          if (progressText) {
            progressText.textContent = '100%';
          }
          
          // Complete all steps
          for (let i = 1; i <= 4; i++) {
            const stepElement = shadowRoot.getElementById('vton-step-' + i);
            if (stepElement) {
              stepElement.classList.remove('active');
              stepElement.classList.add('completed');
            }
          }
        }
      }
      
      function generateTryOn(shadowRoot, state) {
        if (!state.userPhoto || !state.productId) {
          return;
        }
        
        const loading = shadowRoot.getElementById('vton-loading');
        const generateBtn = shadowRoot.getElementById('vton-generate-btn');
        const result = shadowRoot.getElementById('vton-result');
        const error = shadowRoot.getElementById('vton-error');
        
        // Show loading
        if (loading) loading.classList.add('active');
        if (generateBtn) generateBtn.disabled = true;
        if (result) {
          result.classList.remove('active');
          result.innerHTML = '';
        }
        if (error) {
          error.classList.remove('active');
          error.textContent = '';
        }
        
        // Start rotating loading messages
        startLoadingMessages(shadowRoot);
        
        // Construct absolute URL for app proxy
        const url = window.location.origin + '/apps/tryon/generate?shop=' + encodeURIComponent(state.shop) + '&product_id=' + encodeURIComponent(state.productId);
        
        fetch(url, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            user_photo: state.userPhoto,
            product_id: state.productId,
            product_image_url: state.productImageUrl
          })
        }).then(function(response) {
          console.log('[VTON] Response status:', response.status, response.statusText);
          if (!response.ok) {
            return response.text().then(function(text) {
              console.error('[VTON] Error response:', text);
              throw new Error('Generation failed: ' + response.status + ' - ' + text);
            });
          }
          return response.json();
        }).then(function(data) {
          console.log('[VTON] Generation response data:', JSON.stringify(data, null, 2));
          
          // Extract result URL (multiple formats possible)
          state.resultImageUrl = data.result_url || data.image_url || data.output || 
                                 (data.result && (data.result.url || data.result)) || 
                                 (Array.isArray(data.result) && data.result[0]) ||
                                 (data.data && data.data.result_url) ||
                                 (data.data && data.data.url);
          
          console.log('[VTON] Extracted result URL:', state.resultImageUrl);
          console.log('[VTON] Result URL type:', typeof state.resultImageUrl);
          console.log('[VTON] Result element exists:', !!result);
          
          // Validate result URL
          if (!state.resultImageUrl || typeof state.resultImageUrl !== 'string') {
            console.error('[VTON] Invalid result URL format:', {
              resultImageUrl: state.resultImageUrl,
              type: typeof state.resultImageUrl,
              fullData: data
            });
            throw new Error('Invalid result URL format received from server');
          }
          
          if (!state.resultImageUrl.startsWith('http')) {
            console.error('[VTON] Result URL is not a valid HTTP URL:', state.resultImageUrl);
            throw new Error('Result URL is not a valid HTTP URL');
          }
          
          // Complete progress to 100% before stopping
          const progressBar = shadowRoot.getElementById('vton-progress-bar');
          const progressText = shadowRoot.getElementById('vton-progress-text');
          if (progressBar) {
            progressBar.style.width = '100%';
          }
          if (progressText) {
            progressText.textContent = '100%';
          }
          
          // Complete all steps
          for (let i = 1; i <= 4; i++) {
            const stepElement = shadowRoot.getElementById('vton-step-' + i);
            if (stepElement) {
              stepElement.classList.remove('active');
              stepElement.classList.add('completed');
            }
          }
          
          // Stop loading messages
          stopLoadingMessages(shadowRoot);
          
          // Hide loading
          if (loading) loading.classList.remove('active');
          
          // Display result with "Add to Cart" button
          if (result && state.resultImageUrl && typeof state.resultImageUrl === 'string' && state.resultImageUrl.startsWith('http')) {
            result.classList.add('active');
            const buttonBg = state.widgetSettings.widget_bg || '#000000';
            const buttonColor = state.widgetSettings.widget_color || '#ffffff';
            result.innerHTML = 
              '<img src="' + state.resultImageUrl + '" alt="Result" style="width: 100%; border-radius: 8px; display: block; margin-bottom: 16px;" />' +
              '<button class="vton-add-to-cart-btn" style="width: 100%; padding: 14px; border: none; border-radius: 4px; font-size: 16px; font-weight: 600; cursor: pointer; background: ' + buttonBg + '; color: ' + buttonColor + '; transition: all 0.3s ease;" onclick="window.vtonWidgetInstance.handleAddToCart()">' +
              'Add to Cart' +
              '</button>';
            console.log('[VTON] Result displayed successfully with Add to Cart button');
            console.log('[VTON] Image src:', state.resultImageUrl);
          } else {
            console.error('[VTON] Cannot display result:', {
              hasResult: !!result,
              resultImageUrl: state.resultImageUrl,
              resultImageUrlType: typeof state.resultImageUrl,
              data: data
            });
            if (error) {
              error.classList.add('active');
              error.textContent = 'Error: Unable to display the result. Please try again.';
            }
          }
          
          if (generateBtn) generateBtn.disabled = false;
        }).catch(function(error) {
          console.error('[VTON] Generation error:', error);
          
          // Stop loading messages
          stopLoadingMessages(shadowRoot);
          
          if (loading) loading.classList.remove('active');
          if (error) {
            error.classList.add('active');
            error.textContent = 'An error occurred. Please try again.';
          }
          if (generateBtn) generateBtn.disabled = false;
        });
      }
    })();
  </script>
{% endif %}

{% schema %}
{
  "name": "Virtual Try-On Widget",
  "target": "section",
  "settings": []
}
{% endschema %}
