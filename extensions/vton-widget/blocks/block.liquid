{% comment %}
  Virtual Try-On Widget - App Embed Block
  This block injects the VTON widget script on product pages
{% endcomment %}

{% if template.name == 'product' %}
  <script>
    (function() {
      'use strict';
      
      // Production mode: disable all logs for performance
      const isProduction = true; // Set to false for debugging
      const log = isProduction ? function() {} : console.log.bind(console);
      const warn = isProduction ? function() {} : console.warn.bind(console);
      const error = console.error.bind(console); // Always log errors
      
      // App URL - try to get from meta tag or use default
      // This should be configured in Shopify App Proxy settings
      const APP_URL = (function() {
        // Try to get from meta tag first
        const appUrlMeta = document.querySelector('meta[name="vton-app-url"]');
        if (appUrlMeta) {
          return appUrlMeta.getAttribute('content');
        }
        // Fallback: Try to detect from current domain or use default Railway URL
        // For production, this should be set via App Proxy configuration
        return 'https://vton-production-890a.up.railway.app';
      })();
      
      // Wait for DOM to be ready and Shopify object to be available
      function waitForShopify() {
        if (window.Shopify && window.Shopify.product) {
          initWidget();
        } else if (document.readyState === 'complete') {
          // DOM is ready but Shopify object might not be loaded yet
          // Wait a bit more for Shopify scripts
          setTimeout(function() {
            if (window.Shopify && window.Shopify.product) {
              initWidget();
      } else {
              // Try anyway, might work with other extraction methods
        initWidget();
            }
          }, 500);
        } else {
          // Wait for DOM
          if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', waitForShopify);
          } else {
            setTimeout(waitForShopify, 100);
          }
        }
      }
      
      waitForShopify();
      
      function initWidget() {
        // Extract shop domain
        const shop = extractShop();
        if (!shop) {
          warn('[VTON] Shop domain not found');
          return;
        }
        
        // Extract product ID from URL
        const productId = extractProductId();
        if (!productId) {
          warn('[VTON] Product ID not found');
          return;
        }
        
        // Extract product handle from URL (fallback for matching)
        const productHandle = extractProductHandle();
        
        log('[VTON] Initializing widget for product:', {
          shop: shop,
          productId: productId,
          productHandle: productHandle,
          currentUrl: window.location.href
        });
        
        // Check status and initialize widget
        log('[VTON] üîç Starting status check...', {
          shop: shop,
          productId: productId,
          productHandle: productHandle,
          timestamp: new Date().toISOString()
        });
        
        checkStatus(shop, productId, productHandle).then(function(status) {
          log('[VTON] ‚úÖ Status check result:', {
            shop: shop,
            productId: productId,
            enabled: status?.enabled,
            shop_enabled: status?.shop_enabled,
            product_enabled: status?.product_enabled,
            widget_settings: status?.widget_settings,
            has_widget_settings: !!status?.widget_settings
          });
          
          if (status && status.enabled === true) {
            log('[VTON] ‚úÖ Widget will be displayed - try-on is enabled');
            log('[VTON] üìã Widget settings:', status.widget_settings || {});
            initializeWidget(shop, productId, productHandle, status.widget_settings || {});
      } else {
            warn('[VTON] ‚ö†Ô∏è Widget NOT displayed - try-on is disabled. Status:', {
              enabled: status?.enabled,
              shop_enabled: status?.shop_enabled,
              product_enabled: status?.product_enabled,
              reason: !status 
                ? 'No status returned' 
                : !status.enabled 
                  ? `Shop enabled: ${status.shop_enabled}, Product enabled: ${status.product_enabled}`
                  : 'Unknown reason'
            });
            warn('[VTON] üí° To enable the widget:');
            warn('[VTON]   1. Go to your app dashboard');
            warn('[VTON]   2. Make sure "Enable app on store" is checked');
            warn('[VTON]   3. Check that the product is not explicitly disabled in the Products page');
          }
        }).catch(function(err) {
          error('[VTON] ‚ùå Failed to check status:', err);
          error('[VTON] Error details:', {
            message: err?.message,
            stack: err?.stack,
            url: window.location.href
          });
        });
      }
      
      function extractShop() {
        if (window.Shopify && window.Shopify.shop) {
          return window.Shopify.shop;
        }
        const hostname = window.location.hostname;
        const match = hostname.match(/([^.]+\.myshopify\.com)/);
        return match ? match[1] : hostname;
      }
      
      function extractProductId() {
        // Try to get Shopify product ID (GID) from various sources
        // Priority order: GID format > numeric ID > handle (last resort)
        
        // 1. Try from Shopify global object (most reliable)
        if (window.Shopify && window.Shopify.product) {
          // Try product.id first
          if (window.Shopify.product.id) {
            const productId = window.Shopify.product.id;
            log('[VTON] Found product ID from window.Shopify.product.id:', productId);
            if (/^\d+$/.test(String(productId))) {
              return 'gid://shopify/Product/' + productId;
            }
            if (String(productId).startsWith('gid://shopify/Product/')) {
              return String(productId);
            }
          }
          // Also try product.product_id (sometimes different from id)
          if (window.Shopify.product.product_id) {
            const productId = window.Shopify.product.product_id;
            log('[VTON] Found product ID from window.Shopify.product.product_id:', productId);
            if (/^\d+$/.test(String(productId))) {
              return 'gid://shopify/Product/' + productId;
            }
            if (String(productId).startsWith('gid://shopify/Product/')) {
              return String(productId);
            }
          }
        }
        
        // 2. Try from JSON-LD structured data (common in Shopify themes)
        const jsonLdScripts = document.querySelectorAll('script[type="application/ld+json"]');
        for (const script of jsonLdScripts) {
          try {
            const data = JSON.parse(script.textContent || '{}');
            if (data['@type'] === 'Product' && data.productID) {
              const productId = String(data.productID);
              log('[VTON] Found product ID from JSON-LD:', productId);
              if (/^\d+$/.test(productId)) {
                return 'gid://shopify/Product/' + productId;
              }
            }
            // Also check for @graph array
            if (data['@graph'] && Array.isArray(data['@graph'])) {
              for (const item of data['@graph']) {
                if (item['@type'] === 'Product' && item.productID) {
                  const productId = String(item.productID);
                  log('[VTON] Found product ID from JSON-LD @graph:', productId);
                  if (/^\d+$/.test(productId)) {
                    return 'gid://shopify/Product/' + productId;
                  }
                }
              }
            }
          } catch (e) {
            // Ignore JSON parse errors
          }
        }
        
        // 3. Try from data attribute on product form
        const productForm = document.querySelector('form[action*="/cart/add"]');
        if (productForm) {
          const productId = productForm.getAttribute('data-product-id') || 
                           productForm.querySelector('[name="id"]')?.getAttribute('value') ||
                           productForm.querySelector('input[name="id"]')?.value;
          if (productId) {
            log('[VTON] Found product ID from form:', productId);
            // Convert numeric ID to GID format if needed
            if (/^\d+$/.test(productId)) {
              return 'gid://shopify/Product/' + productId;
            }
            // Already in GID format
            if (productId.startsWith('gid://shopify/Product/')) {
              return productId;
            }
          }
        }
        
        // 4. Try from meta tags
        const metaSelectors = [
          'meta[property="product:retailer_item_id"]',
          'meta[name="product-id"]',
          'meta[property="og:product:retailer_item_id"]',
          '[data-product-id]'
        ];
        for (const selector of metaSelectors) {
          const element = document.querySelector(selector);
          if (element) {
            const productId = element.getAttribute('content') || 
                             element.getAttribute('data-product-id') ||
                             element.getAttribute('value');
            if (productId) {
              log('[VTON] Found product ID from meta:', productId);
              if (/^\d+$/.test(productId)) {
                return 'gid://shopify/Product/' + productId;
              }
              if (productId.startsWith('gid://shopify/Product/')) {
                return productId;
              }
            }
          }
        }
        
        // 5. Try from variant selectors (often contain product ID)
        const variantSelect = document.querySelector('select[name="id"], select[data-product-id]');
        if (variantSelect) {
          const productId = variantSelect.getAttribute('data-product-id');
          if (productId && /^\d+$/.test(productId)) {
            log('[VTON] Found product ID from variant select:', productId);
            return 'gid://shopify/Product/' + productId;
          }
        }
        
        // 6. Last resort: Try from URL (handle) - backend will try to match
        const urlMatch = window.location.pathname.match(/\/products\/([^\/\?]+)/);
        if (urlMatch) {
          const handle = urlMatch[1];
          warn('[VTON] Could not find product ID, using handle as fallback:', handle);
          return handle; // Return handle as fallback
        }
        
        error('[VTON] Could not extract product ID from any source');
        return null;
      }
      
      function extractProductHandle() {
        // Try from URL (most reliable) - extract handle from /products/handle
        const urlMatch = window.location.pathname.match(/\/products\/([^\/\?]+)/);
        if (urlMatch) {
          const handle = urlMatch[1];
          log('[VTON] Extracted handle from URL:', handle);
          return handle;
        }
        // Try from Shopify object
        if (window.Shopify && window.Shopify.product) {
          if (window.Shopify.product.handle) {
            log('[VTON] Extracted handle from window.Shopify.product.handle:', window.Shopify.product.handle);
            return window.Shopify.product.handle;
          }
          // Also try from product JSON data
          if (window.Shopify.productJson && window.Shopify.productJson.handle) {
            log('[VTON] Extracted handle from window.Shopify.productJson.handle:', window.Shopify.productJson.handle);
            return window.Shopify.productJson.handle;
          }
        }
        // Try from meta tags
        const metaHandle = document.querySelector('meta[property="product:handle"]') || 
                          document.querySelector('[data-product-handle]');
        if (metaHandle) {
          const handle = metaHandle.getAttribute('content') || 
                        metaHandle.getAttribute('data-product-handle');
          if (handle) {
            log('[VTON] Extracted handle from meta tag:', handle);
            return handle;
          }
        }
        warn('[VTON] Could not extract product handle');
        return null;
      }
      
      function checkStatus(shop, productId, productHandle) {
        // Try App Proxy first (if configured), then fallback to direct app URL
        // App Proxy URL: https://store.myshopify.com/apps/tryon/status
        // Direct URL: https://app-url.com/apps/tryon/status
        
        // Try App Proxy first
        let appProxyUrl = window.location.origin + '/apps/tryon/status?shop=' + encodeURIComponent(shop) + '&product_id=' + encodeURIComponent(productId);
        if (productHandle) {
          appProxyUrl += '&product_handle=' + encodeURIComponent(productHandle);
        }
        
        // Fallback: Try to get app URL from meta tag or use a known pattern
        // For Railway deployments, the URL pattern is usually: https://app-name.up.railway.app
        // We'll try App Proxy first, and if it fails, we'll need to use the direct URL
        // Note: The app URL should be configured in Shopify App Proxy settings
        
        return fetch(appProxyUrl, {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json'
          }
        }).then(function(response) {
          if (!response.ok) {
            // If App Proxy fails (404), try direct URL as fallback
            if (response.status === 404) {
              warn('[VTON] ‚ö†Ô∏è App Proxy not available (404), trying direct URL...');
              
              // Use the configured app URL as fallback
              const directUrl = APP_URL + '/apps/tryon/status?shop=' + encodeURIComponent(shop) + '&product_id=' + encodeURIComponent(productId);
              const finalUrl = productHandle ? directUrl + '&product_handle=' + encodeURIComponent(productHandle) : directUrl;
              
              log('[VTON] üîÑ Trying direct URL:', finalUrl);
              
              return fetch(finalUrl, {
                method: 'GET',
                headers: {
                  'Content-Type': 'application/json'
                }
              }).then(function(directResponse) {
                if (!directResponse.ok) {
                  throw new Error('Status check failed: ' + directResponse.status);
                }
                return directResponse.json();
              });
            }
            throw new Error('Status check failed: ' + response.status);
          }
          return response.json();
        }).catch(function(err) {
          error('[VTON] ‚ùå Status check error:', err);
          throw err;
        });
      }
      
      function getProductImage() {
        // Try multiple selectors to find product image
        const selectors = [
          '.product__media img',
          '.product-single__media img',
          '[data-product-image] img',
          '.product-media img',
          '.product-photos img',
          '.product-gallery img',
          'img[data-product-image]',
          '.product__photo img',
          'img.product-featured-image'
        ];
        
        for (const selector of selectors) {
          const img = document.querySelector(selector);
          if (img && img.src) {
            // Get the full-size image URL (remove size parameters)
            const imageUrl = img.src.split('?')[0].replace(/_small|_medium|_large|_grande/g, '');
            return imageUrl;
          }
        }
        
        return null;
      }
      
      function initializeWidget(shop, productId, productHandle, widgetSettings) {
        log('[VTON] üöÄ Initializing widget...', {
          shop: shop,
          productId: productId,
          widgetSettings: widgetSettings
        });
        
        // Find product form container
        const productForm = document.querySelector('form[action*="/cart/add"]');
        if (!productForm || !productForm.parentNode) {
          error('[VTON] ‚ùå Product form not found. The widget requires a form with action="/cart/add" on the product page.');
          error('[VTON] üí° Make sure you are on a product page with an "Add to Cart" button.');
          return;
        }
        
        log('[VTON] ‚úÖ Product form found:', productForm);
        
        // Check if widget already exists
        if (document.getElementById('vton-widget-container')) {
          warn('[VTON] ‚ö†Ô∏è Widget container already exists, skipping initialization');
          return;
        }
        
        // Get product image URL from the page
        const productImageUrl = getProductImage();
        
        // Create widget container
        const container = document.createElement('div');
        container.id = 'vton-widget-container';
        container.setAttribute('data-vton-widget', 'true');
        
        // Find the "Add to Cart" button to insert the widget right after it
        const addToCartButton = productForm.querySelector('button[type="submit"], button[name="add"], [data-add-to-cart], .btn--add-to-cart, .add-to-cart, .product-form__cart-submit, .product-form__submit');
        
        if (addToCartButton && addToCartButton.parentNode) {
          // Insert right after the "Add to Cart" button
          // If the button is in a wrapper (div), insert after the wrapper
          const buttonWrapper = addToCartButton.closest('.product-form__cart-submit-wrapper, .product-form__submit-wrapper, .product-form__cart, .product-form__buttons, .product-form__actions, div');
          
          if (buttonWrapper && buttonWrapper !== productForm) {
            // Insert after the button wrapper
            buttonWrapper.parentNode.insertBefore(container, buttonWrapper.nextSibling);
          } else {
            // Insert after the button directly
            addToCartButton.parentNode.insertBefore(container, addToCartButton.nextSibling);
          }
            } else {
          // Fallback: Insert after the form if button not found
          productForm.parentNode.insertBefore(container, productForm.nextSibling);
        }
        
        // Create shadow DOM
        const shadowRoot = container.attachShadow({ mode: 'closed' });
        
        // Widget state
        const state = {
          shop: shop,
          productId: productId,
          productHandle: productHandle,
          widgetSettings: widgetSettings,
          productImageUrl: productImageUrl,
          userPhoto: null,
          resultImageUrl: null,
          modalOpen: false,
          isGenerating: false // Flag to prevent double submission
        };
        
        // Render widget
        renderWidget(shadowRoot, state);
        
        log('[VTON] ‚úÖ Widget initialized and rendered successfully!', {
          containerId: container.id,
          productId: productId,
          productImageUrl: productImageUrl
        });
        
        // Make widget accessible globally for event handlers
        window.vtonWidgetInstance = {
          openModal: function() {
            openModal(shadowRoot, state);
          },
          closeModal: function() {
            closeModal(shadowRoot, state);
          },
          triggerFileInput: function() {
            const fileInput = shadowRoot.getElementById('vton-file-input');
            if (fileInput) fileInput.click();
          },
          generate: function() {
            generateTryOn(shadowRoot, state);
          },
          handleFileChange: function(event) {
            handleFileChange(event, shadowRoot, state);
          },
          handleAddToCart: function() {
            handleAddToCart(shadowRoot, state);
          },
          startLoadingMessages: function() {
            startLoadingMessages(shadowRoot);
          },
          stopLoadingMessages: function() {
            stopLoadingMessages(shadowRoot);
          }
        };
      }
      
      function renderWidget(shadowRoot, state) {
        const settings = state.widgetSettings;
        const buttonText = settings.widget_text || 'Try It On Now ‚ú®';
        const buttonBg = settings.widget_bg || '#000000';
        const buttonColor = settings.widget_color || '#ffffff';
        
        shadowRoot.innerHTML = `
          <style>
            .vton-widget-container {
              margin: 24px 0 0 0;
              width: 100%;
              display: block;
            }
            .vton-button {
              width: 100%;
              padding: 20px 32px;
              border: none;
              border-radius: 12px;
              font-size: 16px;
              font-weight: 700;
              cursor: pointer;
              transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
              box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1), 0 2px 4px rgba(0, 0, 0, 0.06);
              letter-spacing: 0.02em;
              position: relative;
              overflow: hidden;
            }
            .vton-button::before {
              content: '';
              position: absolute;
              top: 0;
              left: -100%;
              width: 100%;
              height: 100%;
              background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.15), transparent);
              transition: left 0.5s;
            }
            .vton-button:hover::before {
              left: 100%;
              }
              .vton-button:hover {
              transform: translateY(-3px);
              box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15), 0 4px 8px rgba(0, 0, 0, 0.1);
            }
            .vton-button:active {
              transform: translateY(-1px);
              box-shadow: 0 4px 12px rgba(0, 0, 0, 0.12), 0 2px 4px rgba(0, 0, 0, 0.08);
            }
            .vton-modal-overlay {
              position: fixed;
              top: 0;
              left: 0;
              right: 0;
              bottom: 0;
              background: rgba(0, 0, 0, 0.75);
              backdrop-filter: blur(12px) saturate(180%);
              -webkit-backdrop-filter: blur(12px) saturate(180%);
              display: none;
              align-items: center;
              justify-content: center;
              z-index: 99999;
              padding: 24px;
              animation: fadeIn 0.2s ease-out;
            }
            @keyframes fadeIn {
              from { opacity: 0; }
              to { opacity: 1; }
            }
            .vton-modal-overlay.active {
              display: flex;
            }
            .vton-modal {
              background: #ffffff;
              border-radius: 24px;
              max-width: 640px;
              width: 100%;
              max-height: 90vh;
              overflow: hidden;
              position: relative;
              display: flex;
              flex-direction: column;
              box-shadow: 0 32px 80px rgba(0, 0, 0, 0.3), 0 12px 24px rgba(0, 0, 0, 0.2);
              border: 1px solid rgba(255, 255, 255, 0.2);
              animation: slideUp 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            }
            @keyframes slideUp {
              from {
                opacity: 0;
                transform: translateY(20px) scale(0.95);
              }
              to {
                opacity: 1;
                transform: translateY(0) scale(1);
              }
            }
            .vton-modal-close {
              position: absolute;
              top: 24px;
              right: 24px;
              background: rgba(0, 0, 0, 0.04);
              border: 1px solid rgba(0, 0, 0, 0.06);
                font-size: 24px;
              cursor: pointer;
              padding: 12px;
              line-height: 1;
              color: #4b5563;
              border-radius: 50%;
              width: 44px;
              height: 44px;
              display: flex;
              align-items: center;
              justify-content: center;
              transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
              z-index: 10;
              font-weight: 300;
            }
            .vton-modal-close:hover {
              background: rgba(0, 0, 0, 0.08);
              border-color: rgba(0, 0, 0, 0.12);
              color: #111827;
              transform: scale(1.1) rotate(90deg);
            }
            .vton-modal-close:active {
              transform: scale(1.05) rotate(90deg);
            }
            .vton-modal-content {
              padding: 48px 40px;
              display: flex;
              flex-direction: column;
              flex: 1;
              overflow: hidden;
            }
            .vton-modal-content.has-result {
              padding: 40px;
              justify-content: center;
            }
            .vton-upload-area {
              border: 2.5px dashed #d1d5db;
              border-radius: 20px;
              padding: 72px 48px;
              text-align: center;
              cursor: pointer;
              margin-bottom: 32px;
              transition: all 0.35s cubic-bezier(0.4, 0, 0.2, 1);
              background: linear-gradient(135deg, #ffffff 0%, #f9fafb 50%, #fafbfc 100%);
              position: relative;
              overflow: hidden;
            }
            .vton-upload-area::before {
              content: '';
              position: absolute;
              top: 0;
              left: 0;
              right: 0;
              bottom: 0;
              border-radius: 20px;
              background: linear-gradient(135deg, rgba(255, 255, 255, 0.6) 0%, rgba(255, 255, 255, 0.2) 50%, transparent 100%);
              opacity: 0;
              transition: opacity 0.35s ease;
            }
            .vton-upload-area::after {
              content: '';
              position: absolute;
              top: -50%;
              left: -50%;
              width: 200%;
              height: 200%;
              background: radial-gradient(circle, rgba(0, 128, 96, 0.05) 0%, transparent 70%);
              opacity: 0;
              transition: opacity 0.35s ease;
            }
              .vton-upload-area:hover {
              border-color: ${buttonBg};
              border-width: 3px;
              background: linear-gradient(135deg, #ffffff 0%, #f0fdf4 50%, #f9fafb 100%);
              box-shadow: 0 8px 32px rgba(0, 128, 96, 0.12), 0 4px 12px rgba(0, 128, 96, 0.08);
              transform: translateY(-4px) scale(1.01);
            }
            .vton-upload-area:hover::before {
              opacity: 1;
            }
            .vton-upload-area:hover::after {
              opacity: 1;
            }
            .vton-upload-area.hidden {
              display: none;
            }
            .vton-upload-area p {
              margin: 0;
              font-size: 17px;
              color: #111827;
              font-weight: 700;
              line-height: 1.6;
              letter-spacing: -0.02em;
            }
            .vton-upload-area p:first-of-type {
              margin-bottom: 8px;
            }
            .vton-upload-area p:last-of-type {
              font-size: 14px;
              color: #6b7280;
              font-weight: 500;
              margin-top: 8px;
              letter-spacing: 0;
            }
            .vton-upload-icon {
              font-size: 72px;
              margin-bottom: 24px;
              display: block;
              filter: drop-shadow(0 4px 12px rgba(0, 0, 0, 0.15));
              transition: all 0.35s cubic-bezier(0.4, 0, 0.2, 1);
              position: relative;
              z-index: 1;
            }
            .vton-upload-area:hover .vton-upload-icon {
              transform: scale(1.1) translateY(-4px);
              filter: drop-shadow(0 6px 16px rgba(0, 128, 96, 0.25));
            }
            .vton-upload-area.has-image {
              border: none;
              padding: 0;
              background: transparent;
            }
            .vton-upload-area.has-image:hover {
              background: transparent;
            }
            .vton-upload-area img {
              max-width: 100%;
              max-height: 280px;
              border-radius: 16px;
              object-fit: contain;
              box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12), 0 4px 8px rgba(0, 0, 0, 0.08);
              border: 1px solid rgba(0, 0, 0, 0.06);
            }
            .vton-privacy-notice {
              font-size: 13px;
              color: #6b7280;
              text-align: center;
              margin: 24px 0;
              flex-shrink: 0;
              line-height: 1.7;
              font-weight: 600;
              padding: 16px 20px;
              background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
              border-radius: 12px;
              border: 1.5px solid #fbbf24;
              box-shadow: 0 2px 8px rgba(251, 191, 36, 0.15);
              position: relative;
              overflow: hidden;
            }
            .vton-privacy-notice::before {
              content: '';
              position: absolute;
              top: 0;
              left: 0;
              right: 0;
              height: 2px;
              background: linear-gradient(90deg, #f59e0b 0%, #fbbf24 100%);
            }
            .vton-privacy-notice.hidden {
              display: none;
            }
            .vton-generate-btn {
              width: 100%;
              padding: 20px 32px;
              border: none;
              border-radius: 12px;
              font-size: 16px;
              font-weight: 700;
              cursor: pointer;
              margin-top: 24px;
              transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
              box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1), 0 2px 4px rgba(0, 0, 0, 0.06);
              letter-spacing: 0.02em;
              position: relative;
              overflow: hidden;
            }
            .vton-generate-btn::before {
              content: '';
              position: absolute;
              top: 0;
              left: -100%;
              width: 100%;
              height: 100%;
              background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.15), transparent);
              transition: left 0.5s;
            }
            .vton-generate-btn:hover:not(:disabled)::before {
              left: 100%;
            }
            .vton-generate-btn:hover:not(:disabled) {
              transform: translateY(-3px);
              box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15), 0 4px 8px rgba(0, 0, 0, 0.1);
            }
            .vton-generate-btn.hidden {
              display: none;
            }
            .vton-generate-btn:disabled {
              opacity: 0.5;
              cursor: not-allowed;
              transform: none;
            }
            .vton-loading {
              text-align: center;
              padding: 64px 40px;
              display: none;
              flex-shrink: 0;
              background: linear-gradient(to bottom, #fafbfc 0%, #ffffff 100%);
              border-radius: 20px;
              margin: 24px 0;
              position: relative;
              overflow: hidden;
            }
            .vton-loading::before {
              content: '';
              position: absolute;
              top: 0;
              left: 0;
              right: 0;
              height: 3px;
              background: linear-gradient(90deg, ${buttonBg} 0%, ${buttonBg}cc 50%, ${buttonBg} 100%);
              background-size: 200% 100%;
              animation: loadingGradient 2s ease-in-out infinite;
            }
            @keyframes loadingGradient {
              0%, 100% { background-position: 0% 50%; }
              50% { background-position: 100% 50%; }
            }
            .vton-loading.active {
              display: block;
              animation: fadeInUp 0.4s ease-out;
            }
            @keyframes fadeInUp {
              from {
                opacity: 0;
                transform: translateY(10px);
              }
              to {
                opacity: 1;
                transform: translateY(0);
              }
            }
            .vton-spinner {
              border: 6px solid #f0f4f8;
              border-top: 6px solid ${buttonBg};
              border-right: 6px solid ${buttonBg};
              border-radius: 50%;
              width: 64px;
              height: 64px;
              animation: spin 1s cubic-bezier(0.68, -0.55, 0.265, 1.55) infinite;
              margin: 0 auto 40px;
              box-shadow: 0 8px 24px rgba(0, 0, 0, 0.1), 0 4px 8px rgba(0, 0, 0, 0.06);
              position: relative;
            }
            .vton-spinner::before {
              content: '';
              position: absolute;
              top: -6px;
              left: -6px;
              right: -6px;
              bottom: -6px;
              border-radius: 50%;
              border: 6px solid transparent;
              border-top-color: ${buttonBg}33;
              animation: spin 1.5s linear infinite reverse;
            }
            .vton-loading-text {
              margin-top: 32px;
              font-size: 20px;
              color: #111827;
              font-weight: 800;
              min-height: 32px;
              transition: opacity 0.4s cubic-bezier(0.4, 0, 0.2, 1);
              letter-spacing: -0.02em;
              line-height: 1.4;
            }
            .vton-loading-text.fade-out {
              opacity: 0;
            }
            .vton-loading-subtext {
              margin-top: 20px;
              font-size: 15px;
              color: #6b7280;
              line-height: 1.7;
              font-weight: 500;
              letter-spacing: 0.01em;
            }
            .vton-progress-container {
                width: 100%;
              max-width: 420px;
              margin: 40px auto 20px;
              background: #e5e7eb;
              border-radius: 16px;
              height: 10px;
              overflow: hidden;
              position: relative;
              box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.06);
            }
            .vton-progress-bar {
              height: 100%;
              background: linear-gradient(90deg, ${buttonBg} 0%, ${buttonBg}dd 50%, ${buttonBg} 100%);
              background-size: 200% 100%;
              border-radius: 16px;
              width: 0%;
              transition: width 0.6s cubic-bezier(0.4, 0, 0.2, 1);
              position: relative;
              overflow: hidden;
              box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            }
            .vton-progress-bar::after {
              content: '';
                position: absolute;
                top: 0;
                left: 0;
              bottom: 0;
              right: 0;
              background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
              animation: shimmer 2.5s infinite;
            }
            .vton-progress-info {
              display: flex;
              justify-content: space-between;
              align-items: center;
              max-width: 420px;
              margin: 16px auto 0;
              padding: 0 4px;
            }
            .vton-progress-text {
              font-size: 14px;
              font-weight: 700;
              color: ${buttonBg};
              letter-spacing: 0.02em;
            }
            .vton-timer-value {
              font-size: 13px;
              font-weight: 600;
              color: #9ca3af;
              font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            }
            @keyframes shimmer {
              0% { transform: translateX(-100%); }
              100% { transform: translateX(100%); }
            }
            .vton-progress-text {
              text-align: center;
              font-size: 13px;
              color: #666;
              margin-top: 8px;
              font-weight: 500;
            }
            .vton-timer {
              text-align: center;
              font-size: 12px;
              color: #999;
              margin-top: 12px;
              font-family: monospace;
            }
            .vton-steps {
              display: none;
            }
            .vton-step {
              padding: 6px 12px;
              border-radius: 20px;
              font-size: 11px;
              font-weight: 600;
              background: #f0f0f0;
              color: #999;
              transition: all 0.3s ease;
            }
            .vton-step.active {
              background: ${buttonBg};
              color: ${buttonColor};
              transform: scale(1.1);
            }
            .vton-step.completed {
              background: #28a745;
              color: #fff;
            }
            .vton-loading-dots {
              display: inline-block;
              margin-left: 6px;
              vertical-align: middle;
            }
            .vton-loading-dots span {
              display: inline-block;
              width: 6px;
              height: 6px;
              border-radius: 50%;
              background: ${buttonBg};
              margin: 0 3px;
              animation: dotPulse 1.6s infinite ease-in-out;
              box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            }
            .vton-loading-dots span:nth-child(1) { animation-delay: 0s; }
            .vton-loading-dots span:nth-child(2) { animation-delay: 0.25s; }
            .vton-loading-dots span:nth-child(3) { animation-delay: 0.5s; }
            @keyframes dotPulse {
              0%, 80%, 100% { 
                transform: scale(0.7) translateY(0);
                opacity: 0.4;
              }
              40% { 
                transform: scale(1.3) translateY(-2px);
                opacity: 1;
              }
            }
            @keyframes spin {
              0% { transform: rotate(0deg); }
              100% { transform: rotate(360deg); }
            }
            .vton-result {
              display: none;
              flex: 1;
              overflow: hidden;
              display: flex;
              flex-direction: column;
              align-items: center;
              justify-content: center;
              min-height: 0;
            }
            .vton-result.active {
              display: flex;
            }
            .vton-result-content {
              width: 100%;
              display: flex;
              flex-direction: column;
              align-items: center;
              justify-content: center;
              gap: 24px;
            }
            .vton-result-title {
              font-size: 24px;
              font-weight: 800;
              color: #111827;
              text-align: center;
              margin: 0 0 8px 0;
              letter-spacing: -0.02em;
              line-height: 1.3;
            }
            .vton-result img {
              max-width: 100%;
              max-height: 55vh;
              width: auto;
              height: auto;
              border-radius: 20px;
              object-fit: contain;
              display: block;
              box-shadow: 0 16px 40px rgba(0, 0, 0, 0.18), 0 8px 16px rgba(0, 0, 0, 0.12);
              border: 1px solid rgba(0, 0, 0, 0.06);
              background: #ffffff;
            }
            .vton-add-to-cart-btn {
              width: 100%;
              max-width: 420px;
              padding: 22px 40px;
              border: none;
              border-radius: 14px;
              font-size: 17px;
              font-weight: 800;
              cursor: pointer;
              transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
              box-shadow: 0 6px 20px rgba(0, 0, 0, 0.18), 0 3px 6px rgba(0, 0, 0, 0.12);
              letter-spacing: 0.03em;
              position: relative;
              overflow: hidden;
            }
            .vton-add-to-cart-btn::before {
              content: '';
                position: absolute;
                top: 0;
              left: -100%;
              width: 100%;
              height: 100%;
              background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
              transition: left 0.5s;
            }
            .vton-add-to-cart-btn:hover::before {
              left: 100%;
            }
            .vton-add-to-cart-btn:hover {
              transform: translateY(-3px);
              box-shadow: 0 10px 32px rgba(0, 0, 0, 0.22), 0 6px 12px rgba(0, 0, 0, 0.15);
            }
            .vton-add-to-cart-btn:active {
              transform: translateY(-1px);
              box-shadow: 0 6px 20px rgba(0, 0, 0, 0.18), 0 3px 6px rgba(0, 0, 0, 0.12);
            }
            .vton-error {
              color: #dc2626;
              text-align: center;
              padding: 24px 28px;
              display: none;
              background: linear-gradient(to bottom, #fef2f2 0%, #fee2e2 100%);
              border: 1.5px solid #fecaca;
              border-radius: 14px;
              margin: 24px 0;
              font-size: 15px;
              line-height: 1.7;
              font-weight: 600;
              box-shadow: 0 4px 12px rgba(220, 38, 38, 0.1), 0 2px 4px rgba(220, 38, 38, 0.05);
            }
            .vton-error.active {
              display: block;
            }
            @media (max-width: 640px) {
              .vton-widget-container {
                margin: 20px 0 0 0;
              }
              .vton-button {
                padding: 18px 28px;
                font-size: 15px;
                border-radius: 10px;
              }
              .vton-modal-overlay {
                padding: 0;
              }
              .vton-modal {
                max-width: 100%;
                max-height: 100vh;
                height: 100vh;
                border-radius: 0;
                border: none;
              }
              .vton-modal-content {
                padding: 36px 24px;
                height: 100%;
              }
              .vton-modal-content.has-result {
                padding: 32px 24px;
                justify-content: center;
              }
              .vton-upload-area {
                padding: 56px 28px;
                border-radius: 14px;
              }
              .vton-upload-area p {
                font-size: 15px;
              }
              .vton-generate-btn {
                padding: 18px 28px;
                font-size: 15px;
                border-radius: 10px;
              }
              .vton-modal-close {
                top: 20px;
                right: 20px;
                font-size: 28px;
                padding: 10px;
                width: 40px;
                height: 40px;
                z-index: 10;
              }
              .vton-loading {
                padding: 48px 24px;
              }
              .vton-loading-text {
                font-size: 16px;
              }
              .vton-privacy-notice {
                font-size: 12px;
                padding: 10px 14px;
                margin: 16px 0;
                border-radius: 8px;
              }
              .vton-error {
                padding: 20px 24px;
                font-size: 14px;
                border-radius: 12px;
              }
              .vton-result img {
                max-height: 60vh;
                border-radius: 16px;
              }
              .vton-result-title {
                font-size: 20px;
              }
              .vton-add-to-cart-btn {
                max-width: 100%;
                padding: 18px 28px;
                font-size: 16px;
                border-radius: 12px;
              }
            }
            @media (max-width: 480px) {
              .vton-button {
                padding: 11px 16px;
                font-size: 14px;
              }
              .vton-modal-content {
                padding: 20px;
              }
              .vton-modal-content.has-result {
              padding: 16px;
              }
              .vton-upload-area {
                padding: 32px 16px;
              }
              .vton-generate-btn {
                padding: 12px;
                font-size: 14px;
              }
              .vton-loading {
                padding: 28px 16px;
              }
              .vton-result img {
                max-height: 55vh;
              }
              .vton-result-title {
                font-size: 16px;
              }
              .vton-add-to-cart-btn {
                padding: 14px 20px;
                font-size: 15px;
              }
            }
          </style>
          <div class="vton-widget-container">
            <button class="vton-button" style="background: ${buttonBg}; color: ${buttonColor};" onclick="window.vtonWidgetInstance.openModal()">
              ${buttonText}
            </button>
          </div>
          <div id="vton-modal-overlay" class="vton-modal-overlay" onclick="if(event.target === this) window.vtonWidgetInstance.closeModal()">
            <div class="vton-modal">
              <button class="vton-modal-close" onclick="window.vtonWidgetInstance.closeModal()">&times;</button>
              <div class="vton-modal-content">
                <div id="vton-upload-area" class="vton-upload-area" onclick="window.vtonWidgetInstance.triggerFileInput()">
                  <input type="file" id="vton-file-input" accept="image/*" style="display: none;" onchange="window.vtonWidgetInstance.handleFileChange(event)" />
                  <span class="vton-upload-icon">üì∏</span>
                  <p>Add your photo</p>
                  <p>Front-facing photo recommended for best results</p>
                </div>
                <p class="vton-privacy-notice">üîí Your photos are processed securely and deleted after use</p>
                <button id="vton-generate-btn" class="vton-generate-btn" style="background: ${buttonBg}; color: ${buttonColor};" onclick="window.vtonWidgetInstance.generate()" disabled>
                  Try it on now
                </button>
                <div id="vton-loading" class="vton-loading">
                  <div class="vton-spinner"></div>
                  <p id="vton-loading-message" class="vton-loading-text">Creating your perfect fit<span class="vton-loading-dots"><span></span><span></span><span></span></span></p>
                  <div class="vton-progress-container">
                    <div id="vton-progress-bar" class="vton-progress-bar"></div>
                  </div>
                  <div class="vton-progress-info">
                    <span id="vton-progress-text" class="vton-progress-text">0%</span>
                    <span id="vton-timer-value" class="vton-timer-value">~30s</span>
                  </div>
                  <p class="vton-loading-subtext">Crafting your personalized try-on ‚Äî usually takes about 30 seconds</p>
                </div>
                <div id="vton-result" class="vton-result"></div>
                <div id="vton-error" class="vton-error"></div>
              </div>
            </div>
          </div>
        `;
      }
      
      function openModal(shadowRoot, state) {
        const overlay = shadowRoot.getElementById('vton-modal-overlay');
        if (overlay) {
          overlay.classList.add('active');
          state.modalOpen = true;
        }
      }
      
      function closeModal(shadowRoot, state) {
        const overlay = shadowRoot.getElementById('vton-modal-overlay');
        if (overlay) {
          overlay.classList.remove('active');
          state.modalOpen = false;
        }
      }
      
      function handleFileChange(event, shadowRoot, state) {
        const file = event.target.files && event.target.files[0];
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = function(e) {
          state.userPhoto = e.target.result;
          const uploadArea = shadowRoot.getElementById('vton-upload-area');
          const generateBtn = shadowRoot.getElementById('vton-generate-btn');
          if (uploadArea) {
            uploadArea.className = 'vton-upload-area has-image';
            uploadArea.innerHTML = '<img src="' + state.userPhoto + '" alt="Preview" />';
          }
          if (generateBtn) {
            generateBtn.disabled = false;
          }
        };
        reader.readAsDataURL(file);
      }
      
      function handleAddToCart(shadowRoot, state) {
        log('[VTON] handleAddToCart called');
        
        // Get the button in the result to show loading state
        const atcButton = shadowRoot.querySelector('.vton-add-to-cart-btn');
        const originalButtonText = atcButton ? atcButton.textContent : 'Add to Cart';
        
        // Disable button and show loading
        if (atcButton) {
          atcButton.disabled = true;
          atcButton.textContent = 'Adding to cart...';
          atcButton.style.opacity = '0.7';
          atcButton.style.cursor = 'not-allowed';
        }
        
        // Method 1: Try to find and click the original Add to Cart button (most reliable)
        const addToCartButton = document.querySelector('form[action*="/cart/add"] button[type="submit"], form[action*="/cart/add"] input[type="submit"], button[name="add"], .product-form__cart-submit, [data-add-to-cart], button[type="submit"][form*="product"]');
        
        if (addToCartButton) {
          log('[VTON] Found Add to Cart button, clicking it...');
          
          // Trigger click on the original button
          if (addToCartButton instanceof HTMLElement) {
            addToCartButton.click();
            
            // Update button to show success after a short delay
            setTimeout(function() {
              if (atcButton) {
                atcButton.textContent = '‚úì Added to Cart!';
                atcButton.style.background = '#28a745';
                
                setTimeout(function() {
                  if (atcButton) {
                    atcButton.textContent = originalButtonText;
                    atcButton.style.background = state.widgetSettings.widget_bg || '#000000';
                    atcButton.disabled = false;
                    atcButton.style.opacity = '1';
                    atcButton.style.cursor = 'pointer';
                  }
                }, 2000);
              }
              
              // Track the add to cart event
              trackAddToCart(state);
            }, 500);
            
            return;
          }
        }
        
        // Method 2: Find the form and submit it directly
        const addToCartForm = document.querySelector('form[action*="/cart/add"]');
        
        if (addToCartForm) {
          log('[VTON] Found Add to Cart form, submitting...');
          
          // Check if form has variant selected
          const variantInput = addToCartForm.querySelector('input[name="id"], select[name="id"]');
          if (!variantInput || !variantInput.value) {
            warn('[VTON] No variant selected in form');
            if (atcButton) {
              atcButton.disabled = false;
              atcButton.textContent = originalButtonText;
              atcButton.style.opacity = '1';
              atcButton.style.cursor = 'pointer';
            }
            alert('Please select a product variant (size, color, etc.) before adding to cart.');
            return;
          }
          
          // Submit the form directly
          if (addToCartForm instanceof HTMLFormElement) {
            addToCartForm.submit();
            
            // Update button to show success
            setTimeout(function() {
              if (atcButton) {
                atcButton.textContent = '‚úì Added to Cart!';
                atcButton.style.background = '#28a745';
                
                setTimeout(function() {
                  if (atcButton) {
                    atcButton.textContent = originalButtonText;
                    atcButton.style.background = state.widgetSettings.widget_bg || '#000000';
                    atcButton.disabled = false;
                    atcButton.style.opacity = '1';
                    atcButton.style.cursor = 'pointer';
                  }
                }, 2000);
              }
              
              // Track the add to cart event
              trackAddToCart(state);
            }, 500);
            
            return;
          }
        }
        
        // Method 3: Use AJAX API as fallback
        log('[VTON] Trying AJAX method...');
        
        if (!addToCartForm) {
          error('[VTON] Add to Cart form not found');
          if (atcButton) {
            atcButton.disabled = false;
            atcButton.textContent = originalButtonText;
            atcButton.style.opacity = '1';
            atcButton.style.cursor = 'pointer';
          }
          alert('Unable to find the product form. Please use the regular Add to Cart button on the page.');
          return;
        }
        
        // Collect form data
        const formData = new FormData(addToCartForm);
        
        // Get quantity (default to 1 if not specified)
        let quantity = formData.get('quantity') || '1';
        if (!quantity || quantity === '') {
          quantity = '1';
        }
        
        // Get variant ID (required) - try multiple methods
        let variantId = formData.get('id') || formData.get('variant_id');
        
        // If not found in form data, try to find it in the form inputs
        if (!variantId) {
          const variantInput = addToCartForm.querySelector('input[name="id"], select[name="id"]');
          if (variantInput) {
            variantId = variantInput.value;
          }
        }
        
        if (!variantId) {
          error('[VTON] Variant ID not found in form');
          if (atcButton) {
            atcButton.disabled = false;
            atcButton.textContent = originalButtonText;
            atcButton.style.opacity = '1';
            atcButton.style.cursor = 'pointer';
          }
          alert('Please select a product variant (size, color, etc.) before adding to cart.');
          return;
        }
        
        log('[VTON] Using variant ID:', variantId, 'quantity:', quantity);
        
        // Prepare cart add data
        const cartData = {
          id: variantId,
          quantity: parseInt(quantity, 10) || 1
        };
        
        // Add any additional properties (for custom products)
        formData.forEach((value, key) => {
          if (key.startsWith('properties[')) {
            if (!cartData.properties) {
              cartData.properties = {};
            }
            const propKey = key.replace('properties[', '').replace(']', '');
            cartData.properties[propKey] = value;
          }
        });
        
        log('[VTON] Sending cart data:', cartData);
        
        // Submit to Shopify cart using AJAX
        fetch('/cart/add.js', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Accept': 'application/json'
          },
          body: JSON.stringify(cartData)
        })
        .then(function(response) {
          log('[VTON] Cart add response status:', response.status);
          return response.json().then(function(data) {
            log('[VTON] Cart add response data:', data);
            if (!response.ok) {
              throw new Error(data.description || data.message || 'Failed to add to cart');
            }
            return data;
          });
        })
        .then(function(data) {
          log('[VTON] Product added to cart successfully:', data);
          
          // Update button to show success
          if (atcButton) {
            atcButton.textContent = '‚úì Added to Cart!';
            atcButton.style.background = '#28a745';
            
            // Reset button after 2 seconds
            setTimeout(function() {
              if (atcButton) {
                atcButton.textContent = originalButtonText;
                atcButton.style.background = state.widgetSettings.widget_bg || '#000000';
                atcButton.disabled = false;
                atcButton.style.opacity = '1';
                atcButton.style.cursor = 'pointer';
              }
            }, 2000);
          }
          
          // Track the add to cart event
          trackAddToCart(state);
          
          // Trigger cart drawer/notification if theme supports it
          const cartUpdatedEvent = new CustomEvent('cart:updated', { detail: data });
          document.dispatchEvent(cartUpdatedEvent);
          
          // Also trigger other common cart events
          document.dispatchEvent(new CustomEvent('cart:add', { detail: data }));
          document.dispatchEvent(new Event('cart:refresh'));
          
          // Try to open cart drawer if theme uses this pattern
          const cartDrawerButton = document.querySelector('[data-cart-drawer-toggle], .cart-drawer-toggle, [aria-controls*="cart"], [data-cart-toggle]');
          if (cartDrawerButton) {
            setTimeout(function() {
              cartDrawerButton.click();
            }, 500);
          }
          
          // Try to refresh cart count if theme has a cart count element
          const cartCountElements = document.querySelectorAll('[data-cart-count], .cart-count, #cart-count');
          cartCountElements.forEach(function(el) {
            if (el instanceof HTMLElement) {
              const currentCount = parseInt(el.textContent || '0', 10);
              el.textContent = String(currentCount + parseInt(quantity, 10));
            }
          });
        })
        .catch(function(err) {
          error('[VTON] Error adding to cart:', err);
          
          // Show error on button
          if (atcButton) {
            atcButton.textContent = 'Error - Try Again';
            atcButton.style.background = '#dc3545';
            atcButton.disabled = false;
            atcButton.style.opacity = '1';
            atcButton.style.cursor = 'pointer';
            
            // Reset after 3 seconds
            setTimeout(function() {
              if (atcButton) {
                atcButton.textContent = originalButtonText;
                atcButton.style.background = state.widgetSettings.widget_bg || '#000000';
              }
            }, 3000);
          }
          
          // Show alert for user feedback
          alert('Unable to add product to cart: ' + (error.message || 'Unknown error') + '. Please try using the regular Add to Cart button on the page.');
        });
      }
      
      function trackAddToCart(state) {
        // Track the add to cart event for analytics
        // Try App Proxy first, fallback to direct URL
        const APP_URL = '{{ shop.metafields.vton.app_url | default: "https://vton-production-890a.up.railway.app" }}';
        let atcUrl = window.location.origin + '/apps/tryon/atc?shop=' + encodeURIComponent(state.shop) + '&product_id=' + encodeURIComponent(state.productId);
        let useAppProxy = true;
        
        fetch(atcUrl, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          }
        }).then(function(response) {
          // If App Proxy failed with 404, try direct URL as fallback
          if (useAppProxy && response.status === 404) {
            warn('[VTON] ‚ö†Ô∏è App Proxy not available (404) for ATC tracking, trying direct URL...');
            useAppProxy = false;
            const directUrl = APP_URL + '/apps/tryon/atc?shop=' + encodeURIComponent(state.shop) + '&product_id=' + encodeURIComponent(state.productId);
            return fetch(directUrl, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json'
              }
            });
          }
          return response;
        }).then(function(response) {
          if (response.ok) {
            log('[VTON] ‚úÖ Add to Cart tracked successfully');
                } else {
            warn('[VTON] ‚ö†Ô∏è Add to Cart tracking returned status:', response.status);
          }
        }).catch(function(err) {
          error('[VTON] ‚ùå Failed to track Add to Cart:', err);
        });
      }
      
      // Loading messages that rotate during generation
      let loadingMessageInterval = null;
      let progressInterval = null;
      let timerInterval = null;
      let tipInterval = null;
      let startTime = null;
      
      // Contextual messages based on elapsed time
      const getContextualMessage = function(elapsedSeconds) {
        if (elapsedSeconds < 10) {
          return [
            '‚ú® Setting up your virtual try-on experience',
            'üì∏ Analyzing your photo with AI precision',
            'üé® Detecting colors and patterns',
            'ü§ñ Initializing advanced algorithms',
            '‚ö° Preparing the magic...'
          ];
        } else if (elapsedSeconds < 20) {
          return [
            'üîÑ Processing your image in high resolution',
            'üéØ Matching your photo with product details',
            'üí´ Applying realistic fabric textures',
            'üåü Creating seamless blend effects',
            'üî¨ Optimizing every pixel for perfection'
          ];
        } else if (elapsedSeconds < 30) {
          return [
            'üé≠ Fine-tuning the fit and proportions',
            'üåà Adjusting lighting and shadows',
            '‚ú® Adding final touches to make it perfect',
            '‚ú® Almost there! Adding the final touches',
            'üíé Polishing every detail for you'
          ];
        } else {
          return [
            '‚è≥ Taking a bit longer than usual, but it\'s worth it!',
            'üé® Creating something truly special for you',
            'üí™ Our AI is working extra hard to make it perfect',
            'üåü Great things take time - your result is almost ready!',
            'üéØ Final quality check in progress...'
          ];
        }
      };
      
      // Fun tips to show during waiting
      const tips = [
        'üí° Tip: Good lighting improves results',
        'üí° Tip: Processing usually takes 30 seconds',
        'üí° Tip: Your photos are deleted after use'
      ];
      
      function startLoadingMessages(shadowRoot) {
        startTime = Date.now();
        let messageIndex = 0;
        let tipIndex = 0;
        let progress = 0;
        let currentStep = 1;
        const messageElement = shadowRoot.getElementById('vton-loading-message');
        const progressBar = shadowRoot.getElementById('vton-progress-bar');
        const progressText = shadowRoot.getElementById('vton-progress-text');
        const timerValue = shadowRoot.getElementById('vton-timer-value');
        const tipElement = shadowRoot.querySelector('.vton-tip');
        
        if (!messageElement) return;
        
        // Start timer with estimated time remaining
        timerInterval = setInterval(function() {
          if (startTime && timerValue) {
            const elapsed = Math.floor((Date.now() - startTime) / 1000);
            const estimatedTotal = 30; // Average 30 seconds
            const remaining = Math.max(0, estimatedTotal - elapsed);
            
            if (remaining > 0 && elapsed < 35) {
              timerValue.textContent = elapsed + 's ‚Ä¢ ~' + remaining + 's left';
            } else {
              timerValue.textContent = elapsed + 's';
            }
          }
        }, 1000);
        
        // Animate progress bar (simulated progress with realistic curve)
        progressInterval = setInterval(function() {
          if (progress < 92) {
            // More realistic progress curve: fast start, slow middle, medium end
            let increment;
            if (progress < 25) {
              increment = 2.5; // Fast start
            } else if (progress < 50) {
              increment = 1.2; // Slower middle
            } else if (progress < 75) {
              increment = 0.9; // Slow near end
            } else {
              increment = 0.6; // Very slow at 90%
            }
            
            progress = Math.min(progress + increment, 92);
            
            if (progressBar) {
              progressBar.style.width = progress + '%';
            }
            if (progressText) {
              progressText.textContent = Math.floor(progress) + '%';
            }
            
            // Update steps based on progress with smoother transitions
            if (progress >= 18 && currentStep === 1) {
              currentStep = 2;
              updateStep(shadowRoot, 1, true);
              updateStep(shadowRoot, 2, false);
            } else if (progress >= 42 && currentStep === 2) {
              currentStep = 3;
              updateStep(shadowRoot, 2, true);
              updateStep(shadowRoot, 3, false);
            } else if (progress >= 68 && currentStep === 3) {
              currentStep = 4;
              updateStep(shadowRoot, 3, true);
              updateStep(shadowRoot, 4, false);
            }
          }
        }, 400);
        
        // Change message every 3 seconds with contextual messages
        loadingMessageInterval = setInterval(function() {
          if (startTime) {
            const elapsed = Math.floor((Date.now() - startTime) / 1000);
            const contextualMessages = getContextualMessage(elapsed);
            messageIndex = (messageIndex + 1) % contextualMessages.length;
            
            if (messageElement) {
              // Fade out
              messageElement.classList.add('fade-out');
              
              // Change text and fade in after short delay
              setTimeout(function() {
                const dots = '<span class="vton-loading-dots"><span></span><span></span><span></span></span>';
                messageElement.innerHTML = contextualMessages[messageIndex] + dots;
                messageElement.classList.remove('fade-out');
              }, 250);
            }
          }
        }, 3000);
        
        // Show tips every 8 seconds
        if (tipElement) {
          tipInterval = setInterval(function() {
            tipIndex = (tipIndex + 1) % tips.length;
            tipElement.style.opacity = '0';
            setTimeout(function() {
              tipElement.textContent = tips[tipIndex];
              tipElement.style.opacity = '1';
            }, 300);
          }, 8000);
        }
      }
      
      function updateStep(shadowRoot, stepNum, completed) {
        const stepElement = shadowRoot.getElementById('vton-step-' + stepNum);
        if (stepElement) {
          stepElement.classList.remove('active');
          if (completed) {
            stepElement.classList.add('completed');
          }
        }
      }
      
      function stopLoadingMessages(shadowRoot) {
        if (loadingMessageInterval) {
          clearInterval(loadingMessageInterval);
          loadingMessageInterval = null;
        }
        if (progressInterval) {
          clearInterval(progressInterval);
          progressInterval = null;
        }
        if (timerInterval) {
          clearInterval(timerInterval);
          timerInterval = null;
        }
        
        if (shadowRoot) {
          // Complete progress bar
          const progressBar = shadowRoot.getElementById('vton-progress-bar');
          const progressText = shadowRoot.getElementById('vton-progress-text');
          if (progressBar) {
            progressBar.style.width = '100%';
          }
          if (progressText) {
            progressText.textContent = '100%';
          }
          
          // Complete all steps
          for (let i = 1; i <= 4; i++) {
            const stepElement = shadowRoot.getElementById('vton-step-' + i);
            if (stepElement) {
              stepElement.classList.remove('active');
              stepElement.classList.add('completed');
            }
          }
        }
      }
      
      function pollJobStatus(shadowRoot, state, jobId, loading, result, generateBtn) {
        const maxAttempts = 60; // 60 attempts * 2 seconds = 120 seconds max
        let attempts = 0;
        
        const pollInterval = setInterval(function() {
          attempts++;
          
          if (attempts > maxAttempts) {
            clearInterval(pollInterval);
            stopLoadingMessages(shadowRoot);
            if (loading) loading.classList.remove('active');
            const errorElement = shadowRoot.getElementById('vton-error');
            if (errorElement) {
              errorElement.classList.add('active');
              errorElement.textContent = 'Generation timed out. Please try again.';
            }
            if (generateBtn) generateBtn.disabled = false;
            return;
          }
          
          // Try App Proxy first, fallback to direct URL
          const statusUrl = window.location.origin + '/apps/tryon/job/' + jobId + '?shop=' + encodeURIComponent(state.shop);
          
          fetch(statusUrl)
            .then(function(response) {
              if (!response.ok) {
                throw new Error('Status check failed: ' + response.status);
              }
              return response.json();
            })
            .then(function(statusData) {
              log('[VTON] Job status:', statusData.status, statusData);
              
              if (statusData.status === 'completed' && statusData.result_url) {
                clearInterval(pollInterval);
                displayResult(shadowRoot, state, statusData.result_url, loading, result, generateBtn);
              } else if (statusData.status === 'failed' || statusData.status === 'error') {
                clearInterval(pollInterval);
                stopLoadingMessages(shadowRoot);
                if (loading) loading.classList.remove('active');
                const errorElement = shadowRoot.getElementById('vton-error');
                if (errorElement) {
                  errorElement.classList.add('active');
                  errorElement.textContent = statusData.error || 'Generation failed. Please try again.';
                }
                if (generateBtn) generateBtn.disabled = false;
              } else if (statusData.status === 'pending') {
                // Continue polling
                log('[VTON] Job still pending, continuing to poll...');
              } else {
                // Unknown status, stop polling after a few attempts
                warn('[VTON] Unknown status:', statusData.status);
                if (attempts > 10) {
                  clearInterval(pollInterval);
                  stopLoadingMessages(shadowRoot);
                  if (loading) loading.classList.remove('active');
                  const errorElement = shadowRoot.getElementById('vton-error');
                  if (errorElement) {
                    errorElement.classList.add('active');
                    errorElement.textContent = 'Unexpected status. Please try again.';
                  }
                  if (generateBtn) generateBtn.disabled = false;
                }
              }
            })
            .catch(function(err) {
              error('[VTON] Polling error:', err);
              // Stop polling after several consecutive errors
              if (attempts > 5 && attempts % 3 === 0) {
                error('[VTON] Multiple polling errors, stopping...');
                clearInterval(pollInterval);
                stopLoadingMessages(shadowRoot);
                if (loading) loading.classList.remove('active');
                const errorElement = shadowRoot.getElementById('vton-error');
                if (errorElement) {
                  errorElement.classList.add('active');
                  errorElement.textContent = 'Connection error. Please try again.';
                }
                if (generateBtn) generateBtn.disabled = false;
              }
              // Otherwise, continue polling (temporary error possible)
            });
        }, 2000); // Poll every 2 seconds
      }
      
      function displayResult(shadowRoot, state, resultUrl, loading, result, generateBtn) {
        state.resultImageUrl = resultUrl;
        
        log('[VTON] Displaying result:', resultUrl);
        
        // Validate result URL
        if (!state.resultImageUrl || typeof state.resultImageUrl !== 'string' || !state.resultImageUrl.startsWith('http')) {
          error('[VTON] Invalid result URL:', state.resultImageUrl);
          const errorElement = shadowRoot.getElementById('vton-error');
          if (errorElement) {
            errorElement.classList.add('active');
            errorElement.textContent = 'Error: Invalid result URL. Please try again.';
          }
          if (generateBtn) generateBtn.disabled = false;
          return;
        }
        
        // Complete progress to 100% before stopping
        const progressBar = shadowRoot.getElementById('vton-progress-bar');
        const progressText = shadowRoot.getElementById('vton-progress-text');
        if (progressBar) {
          progressBar.style.width = '100%';
        }
        if (progressText) {
          progressText.textContent = '100%';
        }
        
        // Complete all steps
        for (let i = 1; i <= 4; i++) {
          const stepElement = shadowRoot.getElementById('vton-step-' + i);
          if (stepElement) {
            stepElement.classList.remove('active');
            stepElement.classList.add('completed');
          }
        }
        
        // Stop loading messages
        stopLoadingMessages(shadowRoot);
        
        // Hide loading
        if (loading) loading.classList.remove('active');
        
        // Hide upload area (source image), generate button, and privacy notice
        const uploadArea = shadowRoot.getElementById('vton-upload-area');
        const modalContent = shadowRoot.querySelector('.vton-modal-content');
        const privacyNotice = shadowRoot.querySelector('.vton-privacy-notice');
        if (uploadArea) {
          uploadArea.classList.add('hidden');
        }
        if (generateBtn) {
          generateBtn.classList.add('hidden');
        }
        if (privacyNotice) {
          privacyNotice.classList.add('hidden');
        }
        if (modalContent) {
          modalContent.classList.add('has-result');
        }
        
        // Display result with "Add to Cart" button - ONLY the result, no original image
        if (result && state.resultImageUrl && typeof state.resultImageUrl === 'string' && state.resultImageUrl.startsWith('http')) {
          result.classList.add('active');
          const buttonBg = state.widgetSettings.widget_bg || '#000000';
          const buttonColor = state.widgetSettings.widget_color || '#ffffff';
          result.innerHTML = 
            '<div class="vton-result-content">' +
            '<h3 class="vton-result-title">Here\'s your result!</h3>' +
            '<img src="' + state.resultImageUrl + '" alt="Try-on result" />' +
            '<button class="vton-add-to-cart-btn" style="background: ' + buttonBg + '; color: ' + buttonColor + ';" onclick="window.vtonWidgetInstance.handleAddToCart()">' +
            'Add to Cart' +
            '</button>' +
            '</div>';
          log('[VTON] Result displayed successfully with Add to Cart button');
        } else {
          error('[VTON] Cannot display result:', {
            hasResult: !!result,
            resultImageUrl: state.resultImageUrl
          });
          const errorElement = shadowRoot.getElementById('vton-error');
          if (errorElement) {
            errorElement.classList.add('active');
            errorElement.textContent = 'Error: Unable to display the result. Please try again.';
          }
        }
        
        if (generateBtn) generateBtn.disabled = false;
      }
      
      function generateTryOn(shadowRoot, state) {
        if (!state.userPhoto || !state.productId) {
          return;
        }
        
        // Prevent double submission
        if (state.isGenerating) {
          warn('[VTON] Generation already in progress, ignoring duplicate request');
          return;
        }
        state.isGenerating = true;
        
        const loading = shadowRoot.getElementById('vton-loading');
        const generateBtn = shadowRoot.getElementById('vton-generate-btn');
        const result = shadowRoot.getElementById('vton-result');
        const errorElement = shadowRoot.getElementById('vton-error');
        
        // Show loading
        if (loading) loading.classList.add('active');
        if (generateBtn) generateBtn.disabled = true;
        if (result) {
          result.classList.remove('active');
          result.innerHTML = '';
        }
        if (errorElement) {
          errorElement.classList.remove('active');
          errorElement.textContent = '';
        }
        
        // Start rotating loading messages
        startLoadingMessages(shadowRoot);
        
        // Construct absolute URL for app proxy
        // Try App Proxy first, fallback to direct URL
        let generateUrl = window.location.origin + '/apps/tryon/generate?shop=' + encodeURIComponent(state.shop) + '&product_id=' + encodeURIComponent(state.productId);
        if (state.productHandle) {
          generateUrl += '&product_handle=' + encodeURIComponent(state.productHandle);
        }
        let useAppProxy = true;
        
        // Helper function to make the fetch request
        // Use a closure variable to track if we've already tried the fallback
        let hasTriedFallback = false;
        function makeGenerateRequest(url) {
          // Create AbortController for timeout handling (90 seconds - plus que 60)
          const controller = new AbortController();
          const timeoutId = setTimeout(() => controller.abort(), 90000); // 90 seconds timeout
          
          return fetch(url, {
          method: 'POST',
          headers: {
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
              user_photo: state.userPhoto,
              product_id: state.productId,
              product_handle: state.productHandle,
              product_image_url: state.productImageUrl
            }),
            signal: controller.signal
          }).then(function(response) {
            clearTimeout(timeoutId);
            
            log('[VTON] Response status:', response.status, response.statusText);
            
            // If App Proxy failed with 404, try direct URL as fallback (only once)
            if (useAppProxy && !hasTriedFallback && response.status === 404) {
              warn('[VTON] ‚ö†Ô∏è App Proxy not available (404), trying direct URL...');
              useAppProxy = false;
              hasTriedFallback = true; // Prevent double fallback
              // Use the configured app URL as fallback
              let directUrl = APP_URL + '/apps/tryon/generate?shop=' + encodeURIComponent(state.shop) + '&product_id=' + encodeURIComponent(state.productId);
              if (state.productHandle) directUrl += '&product_handle=' + encodeURIComponent(state.productHandle);
              log('[VTON] üîÑ Retrying with direct URL:', directUrl);
              return makeGenerateRequest(directUrl);
            }
            
            if (!response.ok) {
              // Clone the response before consuming the body, so we can read it multiple times if needed
              const clonedResponse = response.clone();
              
              // Try to parse as JSON first
              return clonedResponse.json().then(function(errorData) {
                error('[VTON] Error response:', errorData);
                // Extract error message from response
                const errorMessage = errorData?.error || errorData?.message || 'Generation failed: ' + response.status;
                throw new Error(errorMessage);
              }).catch(function(parseError) {
                // If JSON parsing fails, read from original response as text
                return response.text().then(function(text) {
                  error('[VTON] Error response (text):', text);
                  throw new Error(text || 'Generation failed: ' + response.status);
                });
              });
            }
            return response.json();
          }).catch(function(err) {
            clearTimeout(timeoutId);
            // If it's an abort error and we haven't tried fallback, try fallback first
            if (err.name === 'AbortError' && useAppProxy && !hasTriedFallback) {
              warn('[VTON] ‚ö†Ô∏è Request aborted, trying direct URL as fallback...');
              useAppProxy = false;
              hasTriedFallback = true;
              let directUrl = APP_URL + '/apps/tryon/generate?shop=' + encodeURIComponent(state.shop) + '&product_id=' + encodeURIComponent(state.productId);
              if (state.productHandle) directUrl += '&product_handle=' + encodeURIComponent(state.productHandle);
              return makeGenerateRequest(directUrl);
            }
            throw err;
          });
        }
        
        // Start with App Proxy URL
        makeGenerateRequest(generateUrl).then(function(data) {
          log('[VTON] Generation response data:', JSON.stringify(data, null, 2));
          
          // Extract result URL (synchronous mode - result_url should be present)
          state.resultImageUrl = data.result_url || data.image_url || data.output || 
                                 (data.result && (data.result.url || data.result)) || 
                                 (Array.isArray(data.result) && data.result[0]) ||
                                 (data.data && data.data.result_url) ||
                                 (data.data && data.data.url);
          
          log('[VTON] Extracted result URL:', state.resultImageUrl);
          log('[VTON] Result URL type:', typeof state.resultImageUrl);
          
          // Validate result URL
          if (!state.resultImageUrl || typeof state.resultImageUrl !== 'string') {
            error('[VTON] Invalid result URL format:', {
              resultImageUrl: state.resultImageUrl,
              type: typeof state.resultImageUrl,
              fullData: data
            });
            throw new Error('Invalid result URL format received from server');
          }
          
          if (!state.resultImageUrl.startsWith('http')) {
            error('[VTON] Result URL is not a valid HTTP URL:', state.resultImageUrl);
            throw new Error('Result URL is not a valid HTTP URL');
          }
          
          // Complete progress to 100% before stopping
          const progressBar = shadowRoot.getElementById('vton-progress-bar');
          const progressText = shadowRoot.getElementById('vton-progress-text');
          if (progressBar) {
            progressBar.style.width = '100%';
          }
          if (progressText) {
            progressText.textContent = '100%';
          }
          
          // Complete all steps
          for (let i = 1; i <= 4; i++) {
            const stepElement = shadowRoot.getElementById('vton-step-' + i);
            if (stepElement) {
              stepElement.classList.remove('active');
              stepElement.classList.add('completed');
            }
          }
          
          // Stop loading messages
          stopLoadingMessages(shadowRoot);
          
          // Hide loading
          if (loading) loading.classList.remove('active');
          
          // Hide upload area (source image), generate button, and privacy notice
          const uploadArea = shadowRoot.getElementById('vton-upload-area');
          const modalContent = shadowRoot.querySelector('.vton-modal-content');
          const privacyNotice = shadowRoot.querySelector('.vton-privacy-notice');
          if (uploadArea) {
            uploadArea.classList.add('hidden');
          }
          if (generateBtn) {
            generateBtn.classList.add('hidden');
          }
          if (privacyNotice) {
            privacyNotice.classList.add('hidden');
          }
          if (modalContent) {
            modalContent.classList.add('has-result');
          }
          
          // Display result with "Add to Cart" button - ONLY the result, no original image
          if (result && state.resultImageUrl && typeof state.resultImageUrl === 'string' && state.resultImageUrl.startsWith('http')) {
            result.classList.add('active');
            const buttonBg = state.widgetSettings.widget_bg || '#000000';
            const buttonColor = state.widgetSettings.widget_color || '#ffffff';
            result.innerHTML = 
              '<div class="vton-result-content">' +
              '<h3 class="vton-result-title">Here\'s your result!</h3>' +
              '<img src="' + state.resultImageUrl + '" alt="Try-on result" />' +
              '<button class="vton-add-to-cart-btn" style="background: ' + buttonBg + '; color: ' + buttonColor + ';" onclick="window.vtonWidgetInstance.handleAddToCart()">' +
              'Add to Cart' +
              '</button>' +
              '</div>';
            log('[VTON] Result displayed successfully with Add to Cart button');
            log('[VTON] Image src:', state.resultImageUrl);
          } else {
            error('[VTON] Cannot display result:', {
              hasResult: !!result,
              resultImageUrl: state.resultImageUrl,
              resultImageUrlType: typeof state.resultImageUrl,
              data: data
            });
            const errorElement = shadowRoot.getElementById('vton-error');
            if (errorElement) {
              errorElement.classList.add('active');
              errorElement.textContent = 'Error: Unable to display the result. Please try again.';
            }
          }
          
          state.isGenerating = false;
          if (generateBtn) generateBtn.disabled = false;
        }).catch(function(err) {
          state.isGenerating = false;
          error('[VTON] Generation error:', err);
          
          // Stop loading messages
          stopLoadingMessages(shadowRoot);
          
          if (loading) loading.classList.remove('active');
          if (generateBtn) generateBtn.disabled = false;
          const errorElement = shadowRoot.getElementById('vton-error');
          if (errorElement) {
            errorElement.classList.add('active');
            // Extract error message from the error object
            let errorMessage = 'An error occurred. Please try again.';
            
            if (err.message) {
              // Use the error message from the backend if available
              errorMessage = err.message;
            } else if (err.name === 'AbortError' || err.message?.includes('timeout') || err.message?.includes('504')) {
              errorMessage = 'Generation is taking longer than expected. Please wait a moment and check back, or try again.';
            }
            
            errorElement.textContent = errorMessage;
          }
          if (generateBtn) generateBtn.disabled = false;
        });
      }
    })();
  </script>
{% endif %}

{% schema %}
{
  "name": "Virtual Try-On Widget",
  "target": "section",
  "settings": []
}
{% endschema %}
