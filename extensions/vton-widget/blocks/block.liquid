{% comment %}
  Virtual Try-On Widget - App Embed Block
  This block injects the VTON widget script on product pages
{% endcomment %}

{% if template.name == 'product' %}
  <script>
    (function() {
      'use strict';
      
      // Wait for DOM to be ready
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initWidget);
      } else {
        initWidget();
      }
      
      function initWidget() {
        // Extract shop domain
        const shop = extractShop();
        if (!shop) {
          console.warn('[VTON] Shop domain not found');
          return;
        }
        
        // Extract product ID from URL
        const productId = extractProductId();
        if (!productId) {
          console.warn('[VTON] Product ID not found');
          return;
        }
        
        // Check status and initialize widget
        checkStatus(shop, productId).then(function(status) {
          if (status && status.enabled) {
            initializeWidget(shop, productId, status.widget_settings || {});
          }
        }).catch(function(error) {
          console.error('[VTON] Failed to check status:', error);
        });
      }
      
      function extractShop() {
        if (window.Shopify && window.Shopify.shop) {
          return window.Shopify.shop;
        }
        const hostname = window.location.hostname;
        const match = hostname.match(/([^.]+\.myshopify\.com)/);
        return match ? match[1] : hostname;
      }
      
      function extractProductId() {
        // Try from URL
        const urlMatch = window.location.pathname.match(/\/products\/([^\/\?]+)/);
        if (urlMatch) {
          return urlMatch[1];
        }
        // Try from meta tag
        const meta = document.querySelector('meta[property="og:url"]');
        if (meta) {
          const match = meta.content.match(/\/products\/([^\/\?]+)/);
          if (match) return match[1];
        }
        return null;
      }
      
      function checkStatus(shop, productId) {
        // Construct absolute URL for app proxy
        const url = window.location.origin + '/apps/tryon/status?shop=' + encodeURIComponent(shop) + '&product_id=' + encodeURIComponent(productId);
        
        return fetch(url, {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json'
          }
        }).then(function(response) {
          if (!response.ok) {
            throw new Error('Status check failed: ' + response.status);
          }
          return response.json();
        });
      }
      
      function initializeWidget(shop, productId, widgetSettings) {
        // Find product form container
        const productForm = document.querySelector('form[action*="/cart/add"]');
        if (!productForm || !productForm.parentNode) {
          console.warn('[VTON] Product form not found');
          return;
        }
        
        // Check if widget already exists
        if (document.getElementById('vton-widget-container')) {
          return;
        }
        
        // Create widget container
        const container = document.createElement('div');
        container.id = 'vton-widget-container';
        container.setAttribute('data-vton-widget', 'true');
        
        // Insert after product form
        productForm.parentNode.insertBefore(container, productForm.nextSibling);
        
        // Create shadow DOM
        const shadowRoot = container.attachShadow({ mode: 'closed' });
        
        // Widget state
        const state = {
          shop: shop,
          productId: productId,
          widgetSettings: widgetSettings,
          userPhoto: null,
          resultImageUrl: null,
          modalOpen: false
        };
        
        // Render widget
        renderWidget(shadowRoot, state);
        
        // Make widget accessible globally for event handlers
        window.vtonWidgetInstance = {
          openModal: function() {
            openModal(shadowRoot, state);
          },
          closeModal: function() {
            closeModal(shadowRoot, state);
          },
          triggerFileInput: function() {
            const fileInput = shadowRoot.getElementById('vton-file-input');
            if (fileInput) fileInput.click();
          },
          generate: function() {
            generateTryOn(shadowRoot, state);
          },
          handleFileChange: function(event) {
            handleFileChange(event, shadowRoot, state);
          }
        };
      }
      
      function renderWidget(shadowRoot, state) {
        const settings = state.widgetSettings;
        const buttonText = settings.widget_text || 'Try It On Now ‚ú®';
        const buttonBg = settings.widget_bg || '#000000';
        const buttonColor = settings.widget_color || '#ffffff';
        
        shadowRoot.innerHTML = `
          <style>
            .vton-widget-container {
              margin: 20px 0;
              width: 100%;
            }
            .vton-button {
              width: 100%;
              padding: 14px 24px;
              border: none;
              border-radius: 4px;
              font-size: 16px;
              font-weight: 600;
              cursor: pointer;
              transition: opacity 0.2s;
            }
            .vton-button:hover {
              opacity: 0.9;
            }
            .vton-modal-overlay {
              position: fixed;
              top: 0;
              left: 0;
              right: 0;
              bottom: 0;
              background: rgba(0, 0, 0, 0.7);
              display: none;
              align-items: center;
              justify-content: center;
              z-index: 99999;
              padding: 20px;
            }
            .vton-modal-overlay.active {
              display: flex;
            }
            .vton-modal {
              background: white;
              border-radius: 8px;
              max-width: 600px;
              width: 100%;
              max-height: 90vh;
              overflow-y: auto;
              position: relative;
            }
            .vton-modal-close {
              position: absolute;
              top: 12px;
              right: 12px;
              background: none;
              border: none;
              font-size: 28px;
              cursor: pointer;
              padding: 4px 12px;
              line-height: 1;
              color: #666;
            }
            .vton-modal-content {
              padding: 24px;
            }
            .vton-upload-area {
              border: 2px dashed #ccc;
              border-radius: 8px;
              padding: 40px;
              text-align: center;
              cursor: pointer;
              margin-bottom: 16px;
            }
            .vton-upload-area:hover {
              border-color: #999;
            }
            .vton-upload-area.has-image {
              border: none;
              padding: 0;
            }
            .vton-upload-area img {
              max-width: 100%;
              border-radius: 8px;
            }
            .vton-privacy-notice {
              font-size: 12px;
              color: #999;
              text-align: center;
              margin: 12px 0;
              font-style: italic;
            }
            .vton-generate-btn {
              width: 100%;
              padding: 14px;
              border: none;
              border-radius: 4px;
              font-size: 16px;
              font-weight: 600;
              cursor: pointer;
              margin-top: 16px;
            }
            .vton-generate-btn:disabled {
              opacity: 0.6;
              cursor: not-allowed;
            }
            .vton-loading {
              text-align: center;
              padding: 40px;
              display: none;
            }
            .vton-loading.active {
              display: block;
            }
            .vton-spinner {
              border: 3px solid #f3f3f3;
              border-top: 3px solid ${buttonBg};
              border-radius: 50%;
              width: 40px;
              height: 40px;
              animation: spin 1s linear infinite;
              margin: 0 auto 16px;
            }
            .vton-loading-text {
              margin-top: 16px;
              font-size: 14px;
              color: #666;
            }
            @keyframes spin {
              0% { transform: rotate(0deg); }
              100% { transform: rotate(360deg); }
            }
            .vton-result {
              margin-top: 16px;
              display: none;
            }
            .vton-result.active {
              display: block;
            }
            .vton-result img {
              width: 100%;
              border-radius: 8px;
            }
            .vton-error {
              color: #d32f2f;
              text-align: center;
              padding: 16px;
              display: none;
            }
            .vton-error.active {
              display: block;
            }
          </style>
          <div class="vton-widget-container">
            <button class="vton-button" style="background: ${buttonBg}; color: ${buttonColor};" onclick="window.vtonWidgetInstance.openModal()">
              ${buttonText}
            </button>
          </div>
          <div id="vton-modal-overlay" class="vton-modal-overlay" onclick="if(event.target === this) window.vtonWidgetInstance.closeModal()">
            <div class="vton-modal">
              <button class="vton-modal-close" onclick="window.vtonWidgetInstance.closeModal()">&times;</button>
              <div class="vton-modal-content">
                <div id="vton-upload-area" class="vton-upload-area" onclick="window.vtonWidgetInstance.triggerFileInput()">
                  <input type="file" id="vton-file-input" accept="image/*" style="display: none;" onchange="window.vtonWidgetInstance.handleFileChange(event)" />
                  <p>Cliquez pour t√©l√©charger votre photo</p>
                </div>
                <p class="vton-privacy-notice">üîí Aucune donn√©e personnelle n'est stock√©e. Vos photos sont trait√©es de mani√®re s√©curis√©e et supprim√©es apr√®s g√©n√©ration.</p>
                <button id="vton-generate-btn" class="vton-generate-btn" style="background: ${buttonBg}; color: ${buttonColor};" onclick="window.vtonWidgetInstance.generate()" disabled>
                  G√©n√©rer
                </button>
                <div id="vton-loading" class="vton-loading">
                  <div class="vton-spinner"></div>
                  <p class="vton-loading-text">G√©n√©ration en cours...</p>
                  <p class="vton-loading-text">La g√©n√©ration prend environ 30 √† 40 secondes. Veuillez patienter.</p>
                  <p class="vton-privacy-notice">Aucune donn√©e personnelle n'est stock√©e.</p>
                </div>
                <div id="vton-result" class="vton-result"></div>
                <div id="vton-error" class="vton-error"></div>
              </div>
            </div>
          </div>
        `;
      }
      
      function openModal(shadowRoot, state) {
        const overlay = shadowRoot.getElementById('vton-modal-overlay');
        if (overlay) {
          overlay.classList.add('active');
          state.modalOpen = true;
        }
      }
      
      function closeModal(shadowRoot, state) {
        const overlay = shadowRoot.getElementById('vton-modal-overlay');
        if (overlay) {
          overlay.classList.remove('active');
          state.modalOpen = false;
        }
      }
      
      function handleFileChange(event, shadowRoot, state) {
        const file = event.target.files && event.target.files[0];
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = function(e) {
          state.userPhoto = e.target.result;
          const uploadArea = shadowRoot.getElementById('vton-upload-area');
          const generateBtn = shadowRoot.getElementById('vton-generate-btn');
          if (uploadArea) {
            uploadArea.className = 'vton-upload-area has-image';
            uploadArea.innerHTML = '<img src="' + state.userPhoto + '" alt="Preview" />';
          }
          if (generateBtn) {
            generateBtn.disabled = false;
          }
        };
        reader.readAsDataURL(file);
      }
      
      function generateTryOn(shadowRoot, state) {
        if (!state.userPhoto || !state.productId) {
          return;
        }
        
        const loading = shadowRoot.getElementById('vton-loading');
        const generateBtn = shadowRoot.getElementById('vton-generate-btn');
        const result = shadowRoot.getElementById('vton-result');
        const error = shadowRoot.getElementById('vton-error');
        
        // Show loading
        if (loading) loading.classList.add('active');
        if (generateBtn) generateBtn.disabled = true;
        if (result) {
          result.classList.remove('active');
          result.innerHTML = '';
        }
        if (error) {
          error.classList.remove('active');
          error.textContent = '';
        }
        
        // Construct absolute URL for app proxy
        const url = window.location.origin + '/apps/tryon/generate?shop=' + encodeURIComponent(state.shop) + '&product_id=' + encodeURIComponent(state.productId);
        
        fetch(url, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            user_photo: state.userPhoto,
            product_id: state.productId
          })
        }).then(function(response) {
          if (!response.ok) {
            throw new Error('Generation failed: ' + response.status);
          }
          return response.json();
        }).then(function(data) {
          state.resultImageUrl = data.result_url || data.image_url;
          if (loading) loading.classList.remove('active');
          if (result && state.resultImageUrl) {
            result.classList.add('active');
            result.innerHTML = '<img src="' + state.resultImageUrl + '" alt="Result" />';
          }
          if (generateBtn) generateBtn.disabled = false;
        }).catch(function(error) {
          console.error('[VTON] Generation error:', error);
          if (loading) loading.classList.remove('active');
          if (error) {
            error.classList.add('active');
            error.textContent = 'Une erreur est survenue. Veuillez r√©essayer.';
          }
          if (generateBtn) generateBtn.disabled = false;
        });
      }
    })();
  </script>
{% endif %}

{% schema %}
{
  "name": "Virtual Try-On Widget",
  "target": "section",
  "settings": []
}
{% endschema %}
